/*!
 * Socket.IO v4.5.2
 * (c) 2014-2022 Guillermo Rauch
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).io=t()}(this,(function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function r(){return r=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r.apply(this,arguments)}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&a(e,t)}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function l(e,t,n){return l=u()?Reflect.construct.bind():function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&a(r,n.prototype),r},l.apply(null,arguments)}function c(e){var t="function"==typeof Map?new Map:void 0;return c=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return l(e,arguments,o(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),a(i,e)},c(e)}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}function f(e){var t=u();return function(){var n,i=o(e);if(t){var r=o(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return d(this,n)}}function p(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=o(e)););return e}function v(){return v="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var i=p(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(arguments.length<3?e:n):r.value}},v.apply(this,arguments)}function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function m(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return g(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?g(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}var y=Object.create(null);y.open="0",y.close="1",y.ping="2",y.pong="3",y.message="4",y.upgrade="5",y.noop="6";var w=Object.create(null);Object.keys(y).forEach((function(e){w[y[e]]=e}));for(var b={type:"error",data:"parser error"},k="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),_="function"==typeof ArrayBuffer,x=function(e,t,n){var i,r=e.type,s=e.data;return k&&s instanceof Blob?t?n(s):T(s,n):_&&(s instanceof ArrayBuffer||(i=s,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(i):i&&i.buffer instanceof ArrayBuffer))?t?n(s):T(new Blob([s]),n):n(y[r]+(s||""))},T=function(e,t){var n=new FileReader;return n.onload=function(){var e=n.result.split(",")[1];t("b"+e)},n.readAsDataURL(e)},C="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",A="undefined"==typeof Uint8Array?[]:new Uint8Array(256),S=0;S<C.length;S++)A[C.charCodeAt(S)]=S;var R="function"==typeof ArrayBuffer,E=function(e,t){if("string"!=typeof e)return{type:"message",data:O(e,t)};var n=e.charAt(0);return"b"===n?{type:"message",data:I(e.substring(1),t)}:w[n]?e.length>1?{type:w[n],data:e.substring(1)}:{type:w[n]}:b},I=function(e,t){if(R){var n=function(e){var t,n,i,r,s,o=.75*e.length,a=e.length,u=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var l=new ArrayBuffer(o),c=new Uint8Array(l);for(t=0;t<a;t+=4)n=A[e.charCodeAt(t)],i=A[e.charCodeAt(t+1)],r=A[e.charCodeAt(t+2)],s=A[e.charCodeAt(t+3)],c[u++]=n<<2|i>>4,c[u++]=(15&i)<<4|r>>2,c[u++]=(3&r)<<6|63&s;return l}(e);return O(n,t)}return{base64:!0,data:e}},O=function(e,t){return"blob"===t&&e instanceof ArrayBuffer?new Blob([e]):e},$=String.fromCharCode(30);function M(e){if(e)return function(e){for(var t in M.prototype)e[t]=M.prototype[t];return e}(e)}M.prototype.on=M.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},M.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},M.prototype.off=M.prototype.removeListener=M.prototype.removeAllListeners=M.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,i=this._callbacks["$"+e];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var r=0;r<i.length;r++)if((n=i[r])===t||n.fn===t){i.splice(r,1);break}return 0===i.length&&delete this._callbacks["$"+e],this},M.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],i=1;i<arguments.length;i++)t[i-1]=arguments[i];if(n){i=0;for(var r=(n=n.slice(0)).length;i<r;++i)n[i].apply(this,t)}return this},M.prototype.emitReserved=M.prototype.emit,M.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},M.prototype.hasListeners=function(e){return!!this.listeners(e).length};var U="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function N(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return n.reduce((function(t,n){return e.hasOwnProperty(n)&&(t[n]=e[n]),t}),{})}var L=setTimeout,P=clearTimeout;function j(e,t){t.useNativeTimers?(e.setTimeoutFn=L.bind(U),e.clearTimeoutFn=P.bind(U)):(e.setTimeoutFn=setTimeout.bind(U),e.clearTimeoutFn=clearTimeout.bind(U))}var B,W=function(e){s(r,e);var n=f(r);function r(e,i,s){var o;return t(this,r),(o=n.call(this,e)).description=i,o.context=s,o.type="TransportError",o}return i(r)}(c(Error)),D=function(e){s(r,e);var n=f(r);function r(e){var i;return t(this,r),(i=n.call(this)).writable=!1,j(h(i),e),i.opts=e,i.query=e.query,i.readyState="",i.socket=e.socket,i}return i(r,[{key:"onError",value:function(e,t,n){return v(o(r.prototype),"emitReserved",this).call(this,"error",new W(e,t,n)),this}},{key:"open",value:function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}},{key:"close",value:function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}},{key:"send",value:function(e){"open"===this.readyState&&this.write(e)}},{key:"onOpen",value:function(){this.readyState="open",this.writable=!0,v(o(r.prototype),"emitReserved",this).call(this,"open")}},{key:"onData",value:function(e){var t=E(e,this.socket.binaryType);this.onPacket(t)}},{key:"onPacket",value:function(e){v(o(r.prototype),"emitReserved",this).call(this,"packet",e)}},{key:"onClose",value:function(e){this.readyState="closed",v(o(r.prototype),"emitReserved",this).call(this,"close",e)}}]),r}(M),V="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),z={},F=0,q=0;function H(e){var t="";do{t=V[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function J(){var e=H(+new Date);return e!==B?(F=0,B=e):e+"."+H(F++)}for(;q<64;q++)z[V[q]]=q;function K(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}function G(e){for(var t={},n=e.split("&"),i=0,r=n.length;i<r;i++){var s=n[i].split("=");t[decodeURIComponent(s[0])]=decodeURIComponent(s[1])}return t}var Y=!1;try{Y="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){}var X=Y;function Q(e){var t=e.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!t||X))return new XMLHttpRequest}catch(e){}if(!t)try{return new(U[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}function Z(){}var ee=null!=new Q({xdomain:!1}).responseType,te=function(e){s(o,e);var n=f(o);function o(e){var i;if(t(this,o),(i=n.call(this,e)).polling=!1,"undefined"!=typeof location){var r="https:"===location.protocol,s=location.port;s||(s=r?"443":"80"),i.xd="undefined"!=typeof location&&e.hostname!==location.hostname||s!==e.port,i.xs=e.secure!==r}var a=e&&e.forceBase64;return i.supportsBinary=ee&&!a,i}return i(o,[{key:"name",get:function(){return"polling"}},{key:"doOpen",value:function(){this.poll()}},{key:"pause",value:function(e){var t=this;this.readyState="pausing";var n=function(){t.readyState="paused",e()};if(this.polling||!this.writable){var i=0;this.polling&&(i++,this.once("pollComplete",(function(){--i||n()}))),this.writable||(i++,this.once("drain",(function(){--i||n()})))}else n()}},{key:"poll",value:function(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}},{key:"onData",value:function(e){var t=this;(function(e,t){for(var n=e.split($),i=[],r=0;r<n.length;r++){var s=E(n[r],t);if(i.push(s),"error"===s.type)break}return i})(e,this.socket.binaryType).forEach((function(e){if("opening"===t.readyState&&"open"===e.type&&t.onOpen(),"close"===e.type)return t.onClose({description:"transport closed by the server"}),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this.poll())}},{key:"doClose",value:function(){var e=this,t=function(){e.write([{type:"close"}])};"open"===this.readyState?t():this.once("open",t)}},{key:"write",value:function(e){var t=this;this.writable=!1,function(e,t){var n=e.length,i=new Array(n),r=0;e.forEach((function(e,s){x(e,!1,(function(e){i[s]=e,++r===n&&t(i.join($))}))}))}(e,(function(e){t.doWrite(e,(function(){t.writable=!0,t.emitReserved("drain")}))}))}},{key:"uri",value:function(){var e=this.query||{},t=this.opts.secure?"https":"http",n="";!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=J()),this.supportsBinary||e.sid||(e.b64=1),this.opts.port&&("https"===t&&443!==Number(this.opts.port)||"http"===t&&80!==Number(this.opts.port))&&(n=":"+this.opts.port);var i=K(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(i.length?"?"+i:"")}},{key:"request",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r(e,{xd:this.xd,xs:this.xs},this.opts),new ne(this.uri(),e)}},{key:"doWrite",value:function(e,t){var n=this,i=this.request({method:"POST",data:e});i.on("success",t),i.on("error",(function(e,t){n.onError("xhr post error",e,t)}))}},{key:"doPoll",value:function(){var e=this,t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(function(t,n){e.onError("xhr poll error",t,n)})),this.pollXhr=t}}]),o}(D),ne=function(e){s(r,e);var n=f(r);function r(e,i){var s;return t(this,r),j(h(s=n.call(this)),i),s.opts=i,s.method=i.method||"GET",s.uri=e,s.async=!1!==i.async,s.data=void 0!==i.data?i.data:null,s.create(),s}return i(r,[{key:"create",value:function(){var e=this,t=N(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this.opts.xd,t.xscheme=!!this.opts.xs;var n=this.xhr=new Q(t);try{n.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders)for(var i in n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0),this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(i)&&n.setRequestHeader(i,this.opts.extraHeaders[i])}catch(e){}if("POST"===this.method)try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{n.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in n&&(n.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(n.timeout=this.opts.requestTimeout),n.onreadystatechange=function(){4===n.readyState&&(200===n.status||1223===n.status?e.onLoad():e.setTimeoutFn((function(){e.onError("number"==typeof n.status?n.status:0)}),0))},n.send(this.data)}catch(t){return void this.setTimeoutFn((function(){e.onError(t)}),0)}"undefined"!=typeof document&&(this.index=r.requestsCount++,r.requests[this.index]=this)}},{key:"onError",value:function(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}},{key:"cleanup",value:function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=Z,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete r.requests[this.index],this.xhr=null}}},{key:"onLoad",value:function(){var e=this.xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}},{key:"abort",value:function(){this.cleanup()}}]),r}(M);if(ne.requestsCount=0,ne.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",ie);else if("function"==typeof addEventListener){addEventListener("onpagehide"in U?"pagehide":"unload",ie,!1)}function ie(){for(var e in ne.requests)ne.requests.hasOwnProperty(e)&&ne.requests[e].abort()}var re="function"==typeof Promise&&"function"==typeof Promise.resolve?function(e){return Promise.resolve().then(e)}:function(e,t){return t(e,0)},se=U.WebSocket||U.MozWebSocket,oe="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase(),ae=function(e){s(r,e);var n=f(r);function r(e){var i;return t(this,r),(i=n.call(this,e)).supportsBinary=!e.forceBase64,i}return i(r,[{key:"name",get:function(){return"websocket"}},{key:"doOpen",value:function(){if(this.check()){var e=this.uri(),t=this.opts.protocols,n=oe?{}:N(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=oe?new se(e,t,n):t?new se(e,t):new se(e)}catch(e){return this.emitReserved("error",e)}this.ws.binaryType=this.socket.binaryType||"arraybuffer",this.addEventListeners()}}},{key:"addEventListeners",value:function(){var e=this;this.ws.onopen=function(){e.opts.autoUnref&&e.ws._socket.unref(),e.onOpen()},this.ws.onclose=function(t){return e.onClose({description:"websocket connection closed",context:t})},this.ws.onmessage=function(t){return e.onData(t.data)},this.ws.onerror=function(t){return e.onError("websocket error",t)}}},{key:"write",value:function(e){var t=this;this.writable=!1;for(var n=function(n){var i=e[n],r=n===e.length-1;x(i,t.supportsBinary,(function(e){try{t.ws.send(e)}catch(e){}r&&re((function(){t.writable=!0,t.emitReserved("drain")}),t.setTimeoutFn)}))},i=0;i<e.length;i++)n(i)}},{key:"doClose",value:function(){void 0!==this.ws&&(this.ws.close(),this.ws=null)}},{key:"uri",value:function(){var e=this.query||{},t=this.opts.secure?"wss":"ws",n="";this.opts.port&&("wss"===t&&443!==Number(this.opts.port)||"ws"===t&&80!==Number(this.opts.port))&&(n=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=J()),this.supportsBinary||(e.b64=1);var i=K(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(i.length?"?"+i:"")}},{key:"check",value:function(){return!!se}}]),r}(D),ue={websocket:ae,polling:te},le=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,ce=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function he(e){var t=e,n=e.indexOf("["),i=e.indexOf("]");-1!=n&&-1!=i&&(e=e.substring(0,n)+e.substring(n,i).replace(/:/g,";")+e.substring(i,e.length));for(var r,s,o=le.exec(e||""),a={},u=14;u--;)a[ce[u]]=o[u]||"";return-1!=n&&-1!=i&&(a.source=t,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a.pathNames=function(e,t){var n=/\/{2,9}/g,i=t.replace(n,"/").split("/");"/"!=t.substr(0,1)&&0!==t.length||i.splice(0,1);"/"==t.substr(t.length-1,1)&&i.splice(i.length-1,1);return i}(0,a.path),a.queryKey=(r=a.query,s={},r.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,n){t&&(s[t]=n)})),s),a}var de=function(n){s(a,n);var o=f(a);function a(n){var i,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t(this,a),i=o.call(this),n&&"object"===e(n)&&(s=n,n=null),n?(n=he(n),s.hostname=n.host,s.secure="https"===n.protocol||"wss"===n.protocol,s.port=n.port,n.query&&(s.query=n.query)):s.host&&(s.hostname=he(s.host).host),j(h(i),s),i.secure=null!=s.secure?s.secure:"undefined"!=typeof location&&"https:"===location.protocol,s.hostname&&!s.port&&(s.port=i.secure?"443":"80"),i.hostname=s.hostname||("undefined"!=typeof location?location.hostname:"localhost"),i.port=s.port||("undefined"!=typeof location&&location.port?location.port:i.secure?"443":"80"),i.transports=s.transports||["polling","websocket"],i.readyState="",i.writeBuffer=[],i.prevBufferLen=0,i.opts=r({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},s),i.opts.path=i.opts.path.replace(/\/$/,"")+"/","string"==typeof i.opts.query&&(i.opts.query=G(i.opts.query)),i.id=null,i.upgrades=null,i.pingInterval=null,i.pingTimeout=null,i.pingTimeoutTimer=null,"function"==typeof addEventListener&&(i.opts.closeOnBeforeunload&&addEventListener("beforeunload",(function(){i.transport&&(i.transport.removeAllListeners(),i.transport.close())}),!1),"localhost"!==i.hostname&&(i.offlineEventListener=function(){i.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",i.offlineEventListener,!1))),i.open(),i}return i(a,[{key:"createTransport",value:function(e){var t=r({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);var n=r({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new ue[e](n)}},{key:"open",value:function(){var e,t=this;if(this.opts.rememberUpgrade&&a.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn((function(){t.emitReserved("error","No transports available")}),0);e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}},{key:"setTransport",value:function(e){var t=this;this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",(function(e){return t.onClose("transport close",e)}))}},{key:"probe",value:function(e){var t=this,n=this.createTransport(e),i=!1;a.priorWebsocketSuccess=!1;var r=function(){i||(n.send([{type:"ping",data:"probe"}]),n.once("packet",(function(e){if(!i)if("pong"===e.type&&"probe"===e.data){if(t.upgrading=!0,t.emitReserved("upgrading",n),!n)return;a.priorWebsocketSuccess="websocket"===n.name,t.transport.pause((function(){i||"closed"!==t.readyState&&(h(),t.setTransport(n),n.send([{type:"upgrade"}]),t.emitReserved("upgrade",n),n=null,t.upgrading=!1,t.flush())}))}else{var r=new Error("probe error");r.transport=n.name,t.emitReserved("upgradeError",r)}})))};function s(){i||(i=!0,h(),n.close(),n=null)}var o=function(e){var i=new Error("probe error: "+e);i.transport=n.name,s(),t.emitReserved("upgradeError",i)};function u(){o("transport closed")}function l(){o("socket closed")}function c(e){n&&e.name!==n.name&&s()}var h=function(){n.removeListener("open",r),n.removeListener("error",o),n.removeListener("close",u),t.off("close",l),t.off("upgrading",c)};n.once("open",r),n.once("error",o),n.once("close",u),this.once("close",l),this.once("upgrading",c),n.open()}},{key:"onOpen",value:function(){if(this.readyState="open",a.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause)for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},{key:"onPacket",value:function(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}},{key:"onHandshake",value:function(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}},{key:"resetPingTimeout",value:function(){var e=this;this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn((function(){e.onClose("ping timeout")}),this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}},{key:"onDrain",value:function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}},{key:"flush",value:function(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){var e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}},{key:"getWritablePackets",value:function(){if(!(this.maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;for(var e,t=1,n=0;n<this.writeBuffer.length;n++){var i=this.writeBuffer[n].data;if(i&&(t+="string"==typeof(e=i)?function(e){for(var t=0,n=0,i=0,r=e.length;i<r;i++)(t=e.charCodeAt(i))<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(i++,n+=4);return n}(e):Math.ceil(1.33*(e.byteLength||e.size))),n>0&&t>this.maxPayload)return this.writeBuffer.slice(0,n);t+=2}return this.writeBuffer}},{key:"write",value:function(e,t,n){return this.sendPacket("message",e,t,n),this}},{key:"send",value:function(e,t,n){return this.sendPacket("message",e,t,n),this}},{key:"sendPacket",value:function(e,t,n,i){if("function"==typeof t&&(i=t,t=void 0),"function"==typeof n&&(i=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){(n=n||{}).compress=!1!==n.compress;var r={type:e,data:t,options:n};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}}},{key:"close",value:function(){var e=this,t=function(){e.onClose("forced close"),e.transport.close()},n=function n(){e.off("upgrade",n),e.off("upgradeError",n),t()},i=function(){e.once("upgrade",n),e.once("upgradeError",n)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(function(){e.upgrading?i():t()})):this.upgrading?i():t()),this}},{key:"onError",value:function(e){a.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}},{key:"onClose",value:function(e,t){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"==typeof removeEventListener&&removeEventListener("offline",this.offlineEventListener,!1),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}},{key:"filterUpgrades",value:function(e){for(var t=[],n=0,i=e.length;n<i;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}]),a}(M);de.protocol=4,de.protocol;var fe="function"==typeof ArrayBuffer,pe=Object.prototype.toString,ve="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===pe.call(Blob),ge="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===pe.call(File);function me(e){return fe&&(e instanceof ArrayBuffer||function(e){return"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer}(e))||ve&&e instanceof Blob||ge&&e instanceof File}function ye(t,n){if(!t||"object"!==e(t))return!1;if(Array.isArray(t)){for(var i=0,r=t.length;i<r;i++)if(ye(t[i]))return!0;return!1}if(me(t))return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return ye(t.toJSON(),!0);for(var s in t)if(Object.prototype.hasOwnProperty.call(t,s)&&ye(t[s]))return!0;return!1}function we(e){var t=[],n=e.data,i=e;return i.data=be(n,t),i.attachments=t.length,{packet:i,buffers:t}}function be(t,n){if(!t)return t;if(me(t)){var i={_placeholder:!0,num:n.length};return n.push(t),i}if(Array.isArray(t)){for(var r=new Array(t.length),s=0;s<t.length;s++)r[s]=be(t[s],n);return r}if("object"===e(t)&&!(t instanceof Date)){var o={};for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(o[a]=be(t[a],n));return o}return t}function ke(e,t){return e.data=_e(e.data,t),e.attachments=void 0,e}function _e(t,n){if(!t)return t;if(t&&t._placeholder)return n[t.num];if(Array.isArray(t))for(var i=0;i<t.length;i++)t[i]=_e(t[i],n);else if("object"===e(t))for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(t[r]=_e(t[r],n));return t}var xe;!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(xe||(xe={}));var Te=function(){function e(n){t(this,e),this.replacer=n}return i(e,[{key:"encode",value:function(e){return e.type!==xe.EVENT&&e.type!==xe.ACK||!ye(e)?[this.encodeAsString(e)]:(e.type=e.type===xe.EVENT?xe.BINARY_EVENT:xe.BINARY_ACK,this.encodeAsBinary(e))}},{key:"encodeAsString",value:function(e){var t=""+e.type;return e.type!==xe.BINARY_EVENT&&e.type!==xe.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}},{key:"encodeAsBinary",value:function(e){var t=we(e),n=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(n),i}}]),e}(),Ce=function(n){s(a,n);var r=f(a);function a(e){var n;return t(this,a),(n=r.call(this)).reviver=e,n}return i(a,[{key:"add",value:function(e){var t;if("string"==typeof e)(t=this.decodeString(e)).type===xe.BINARY_EVENT||t.type===xe.BINARY_ACK?(this.reconstructor=new Ae(t),0===t.attachments&&v(o(a.prototype),"emitReserved",this).call(this,"decoded",t)):v(o(a.prototype),"emitReserved",this).call(this,"decoded",t);else{if(!me(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(t=this.reconstructor.takeBinaryData(e))&&(this.reconstructor=null,v(o(a.prototype),"emitReserved",this).call(this,"decoded",t))}}},{key:"decodeString",value:function(e){var t=0,n={type:Number(e.charAt(0))};if(void 0===xe[n.type])throw new Error("unknown packet type "+n.type);if(n.type===xe.BINARY_EVENT||n.type===xe.BINARY_ACK){for(var i=t+1;"-"!==e.charAt(++t)&&t!=e.length;);var r=e.substring(i,t);if(r!=Number(r)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(r)}if("/"===e.charAt(t+1)){for(var s=t+1;++t;){if(","===e.charAt(t))break;if(t===e.length)break}n.nsp=e.substring(s,t)}else n.nsp="/";var o=e.charAt(t+1);if(""!==o&&Number(o)==o){for(var u=t+1;++t;){var l=e.charAt(t);if(null==l||Number(l)!=l){--t;break}if(t===e.length)break}n.id=Number(e.substring(u,t+1))}if(e.charAt(++t)){var c=this.tryParse(e.substr(t));if(!a.isPayloadValid(n.type,c))throw new Error("invalid payload");n.data=c}return n}},{key:"tryParse",value:function(e){try{return JSON.parse(e,this.reviver)}catch(e){return!1}}},{key:"destroy",value:function(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}],[{key:"isPayloadValid",value:function(t,n){switch(t){case xe.CONNECT:return"object"===e(n);case xe.DISCONNECT:return void 0===n;case xe.CONNECT_ERROR:return"string"==typeof n||"object"===e(n);case xe.EVENT:case xe.BINARY_EVENT:return Array.isArray(n)&&n.length>0;case xe.ACK:case xe.BINARY_ACK:return Array.isArray(n)}}}]),a}(M),Ae=function(){function e(n){t(this,e),this.packet=n,this.buffers=[],this.reconPack=n}return i(e,[{key:"takeBinaryData",value:function(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){var t=ke(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}},{key:"finishedReconstruction",value:function(){this.reconPack=null,this.buffers=[]}}]),e}(),Se=Object.freeze({__proto__:null,protocol:5,get PacketType(){return xe},Encoder:Te,Decoder:Ce});function Re(e,t,n){return e.on(t,n),function(){e.off(t,n)}}var Ee=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1}),Ie=function(e){s(r,e);var n=f(r);function r(e,i,s){var o;return t(this,r),(o=n.call(this)).connected=!1,o.receiveBuffer=[],o.sendBuffer=[],o.ids=0,o.acks={},o.flags={},o.io=e,o.nsp=i,s&&s.auth&&(o.auth=s.auth),o.io._autoConnect&&o.open(),o}return i(r,[{key:"disconnected",get:function(){return!this.connected}},{key:"subEvents",value:function(){if(!this.subs){var e=this.io;this.subs=[Re(e,"open",this.onopen.bind(this)),Re(e,"packet",this.onpacket.bind(this)),Re(e,"error",this.onerror.bind(this)),Re(e,"close",this.onclose.bind(this))]}}},{key:"active",get:function(){return!!this.subs}},{key:"connect",value:function(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}},{key:"open",value:function(){return this.connect()}},{key:"send",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.unshift("message"),this.emit.apply(this,t),this}},{key:"emit",value:function(e){if(Ee.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];n.unshift(e);var r={type:xe.EVENT,data:n,options:{}};if(r.options.compress=!1!==this.flags.compress,"function"==typeof n[n.length-1]){var s=this.ids++,o=n.pop();this._registerAckCallback(s,o),r.id=s}var a=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable,u=this.flags.volatile&&(!a||!this.connected);return u||(this.connected?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}},{key:"_registerAckCallback",value:function(e,t){var n=this,i=this.flags.timeout;if(void 0!==i){var r=this.io.setTimeoutFn((function(){delete n.acks[e];for(var i=0;i<n.sendBuffer.length;i++)n.sendBuffer[i].id===e&&n.sendBuffer.splice(i,1);t.call(n,new Error("operation has timed out"))}),i);this.acks[e]=function(){n.io.clearTimeoutFn(r);for(var e=arguments.length,i=new Array(e),s=0;s<e;s++)i[s]=arguments[s];t.apply(n,[null].concat(i))}}else this.acks[e]=t}},{key:"packet",value:function(e){e.nsp=this.nsp,this.io._packet(e)}},{key:"onopen",value:function(){var e=this;"function"==typeof this.auth?this.auth((function(t){e.packet({type:xe.CONNECT,data:t})})):this.packet({type:xe.CONNECT,data:this.auth})}},{key:"onerror",value:function(e){this.connected||this.emitReserved("connect_error",e)}},{key:"onclose",value:function(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}},{key:"onpacket",value:function(e){if(e.nsp===this.nsp)switch(e.type){case xe.CONNECT:if(e.data&&e.data.sid){var t=e.data.sid;this.onconnect(t)}else this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case xe.EVENT:case xe.BINARY_EVENT:this.onevent(e);break;case xe.ACK:case xe.BINARY_ACK:this.onack(e);break;case xe.DISCONNECT:this.ondisconnect();break;case xe.CONNECT_ERROR:this.destroy();var n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n)}}},{key:"onevent",value:function(e){var t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}},{key:"emitEvent",value:function(e){if(this._anyListeners&&this._anyListeners.length){var t,n=m(this._anyListeners.slice());try{for(n.s();!(t=n.n()).done;){t.value.apply(this,e)}}catch(e){n.e(e)}finally{n.f()}}v(o(r.prototype),"emit",this).apply(this,e)}},{key:"ack",value:function(e){var t=this,n=!1;return function(){if(!n){n=!0;for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];t.packet({type:xe.ACK,id:e,data:r})}}}},{key:"onack",value:function(e){var t=this.acks[e.id];"function"==typeof t&&(t.apply(this,e.data),delete this.acks[e.id])}},{key:"onconnect",value:function(e){this.id=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect")}},{key:"emitBuffered",value:function(){var e=this;this.receiveBuffer.forEach((function(t){return e.emitEvent(t)})),this.receiveBuffer=[],this.sendBuffer.forEach((function(t){e.notifyOutgoingListeners(t),e.packet(t)})),this.sendBuffer=[]}},{key:"ondisconnect",value:function(){this.destroy(),this.onclose("io server disconnect")}},{key:"destroy",value:function(){this.subs&&(this.subs.forEach((function(e){return e()})),this.subs=void 0),this.io._destroy(this)}},{key:"disconnect",value:function(){return this.connected&&this.packet({type:xe.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}},{key:"close",value:function(){return this.disconnect()}},{key:"compress",value:function(e){return this.flags.compress=e,this}},{key:"volatile",get:function(){return this.flags.volatile=!0,this}},{key:"timeout",value:function(e){return this.flags.timeout=e,this}},{key:"onAny",value:function(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}},{key:"prependAny",value:function(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}},{key:"offAny",value:function(e){if(!this._anyListeners)return this;if(e){for(var t=this._anyListeners,n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}},{key:"listenersAny",value:function(){return this._anyListeners||[]}},{key:"onAnyOutgoing",value:function(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}},{key:"prependAnyOutgoing",value:function(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}},{key:"offAnyOutgoing",value:function(e){if(!this._anyOutgoingListeners)return this;if(e){for(var t=this._anyOutgoingListeners,n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}},{key:"listenersAnyOutgoing",value:function(){return this._anyOutgoingListeners||[]}},{key:"notifyOutgoingListeners",value:function(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){var t,n=m(this._anyOutgoingListeners.slice());try{for(n.s();!(t=n.n()).done;){t.value.apply(this,e.data)}}catch(e){n.e(e)}finally{n.f()}}}}]),r}(M);function Oe(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Oe.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},Oe.prototype.reset=function(){this.attempts=0},Oe.prototype.setMin=function(e){this.ms=e},Oe.prototype.setMax=function(e){this.max=e},Oe.prototype.setJitter=function(e){this.jitter=e};var $e=function(n){s(o,n);var r=f(o);function o(n,i){var s,a;t(this,o),(s=r.call(this)).nsps={},s.subs=[],n&&"object"===e(n)&&(i=n,n=void 0),(i=i||{}).path=i.path||"/socket.io",s.opts=i,j(h(s),i),s.reconnection(!1!==i.reconnection),s.reconnectionAttempts(i.reconnectionAttempts||1/0),s.reconnectionDelay(i.reconnectionDelay||1e3),s.reconnectionDelayMax(i.reconnectionDelayMax||5e3),s.randomizationFactor(null!==(a=i.randomizationFactor)&&void 0!==a?a:.5),s.backoff=new Oe({min:s.reconnectionDelay(),max:s.reconnectionDelayMax(),jitter:s.randomizationFactor()}),s.timeout(null==i.timeout?2e4:i.timeout),s._readyState="closed",s.uri=n;var u=i.parser||Se;return s.encoder=new u.Encoder,s.decoder=new u.Decoder,s._autoConnect=!1!==i.autoConnect,s._autoConnect&&s.open(),s}return i(o,[{key:"reconnection",value:function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}},{key:"reconnectionAttempts",value:function(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}},{key:"reconnectionDelay",value:function(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}},{key:"randomizationFactor",value:function(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}},{key:"reconnectionDelayMax",value:function(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}},{key:"timeout",value:function(e){return arguments.length?(this._timeout=e,this):this._timeout}},{key:"maybeReconnectOnOpen",value:function(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}},{key:"open",value:function(e){var t=this;if(~this._readyState.indexOf("open"))return this;this.engine=new de(this.uri,this.opts);var n=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;var r=Re(n,"open",(function(){i.onopen(),e&&e()})),s=Re(n,"error",(function(n){i.cleanup(),i._readyState="closed",t.emitReserved("error",n),e?e(n):i.maybeReconnectOnOpen()}));if(!1!==this._timeout){var o=this._timeout;0===o&&r();var a=this.setTimeoutFn((function(){r(),n.close(),n.emit("error",new Error("timeout"))}),o);this.opts.autoUnref&&a.unref(),this.subs.push((function(){clearTimeout(a)}))}return this.subs.push(r),this.subs.push(s),this}},{key:"connect",value:function(e){return this.open(e)}},{key:"onopen",value:function(){this.cleanup(),this._readyState="open",this.emitReserved("open");var e=this.engine;this.subs.push(Re(e,"ping",this.onping.bind(this)),Re(e,"data",this.ondata.bind(this)),Re(e,"error",this.onerror.bind(this)),Re(e,"close",this.onclose.bind(this)),Re(this.decoder,"decoded",this.ondecoded.bind(this)))}},{key:"onping",value:function(){this.emitReserved("ping")}},{key:"ondata",value:function(e){try{this.decoder.add(e)}catch(e){this.onclose("parse error")}}},{key:"ondecoded",value:function(e){this.emitReserved("packet",e)}},{key:"onerror",value:function(e){this.emitReserved("error",e)}},{key:"socket",value:function(e,t){var n=this.nsps[e];return n||(n=new Ie(this,e,t),this.nsps[e]=n),n}},{key:"_destroy",value:function(e){for(var t=0,n=Object.keys(this.nsps);t<n.length;t++){var i=n[t];if(this.nsps[i].active)return}this._close()}},{key:"_packet",value:function(e){for(var t=this.encoder.encode(e),n=0;n<t.length;n++)this.engine.write(t[n],e.options)}},{key:"cleanup",value:function(){this.subs.forEach((function(e){return e()})),this.subs.length=0,this.decoder.destroy()}},{key:"_close",value:function(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}},{key:"disconnect",value:function(){return this._close()}},{key:"onclose",value:function(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}},{key:"reconnect",value:function(){var e=this;if(this._reconnecting||this.skipReconnect)return this;var t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{var n=this.backoff.duration();this._reconnecting=!0;var i=this.setTimeoutFn((function(){t.skipReconnect||(e.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open((function(n){n?(t._reconnecting=!1,t.reconnect(),e.emitReserved("reconnect_error",n)):t.onreconnect()})))}),n);this.opts.autoUnref&&i.unref(),this.subs.push((function(){clearTimeout(i)}))}}},{key:"onreconnect",value:function(){var e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}]),o}(M),Me={};function Ue(t,n){"object"===e(t)&&(n=t,t=void 0);var i,r=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0,i=e;n=n||"undefined"!=typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==n?n.protocol+"//"+e:"https://"+e),i=he(e)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";var r=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+r+":"+i.port+t,i.href=i.protocol+"://"+r+(n&&n.port===i.port?"":":"+i.port),i}(t,(n=n||{}).path||"/socket.io"),s=r.source,o=r.id,a=r.path,u=Me[o]&&a in Me[o].nsps;return n.forceNew||n["force new connection"]||!1===n.multiplex||u?i=new $e(s,n):(Me[o]||(Me[o]=new $e(s,n)),i=Me[o]),r.query&&!n.query&&(n.query=r.queryKey),i.socket(r.path,n)}return r(Ue,{Manager:$e,Socket:Ie,io:Ue,connect:Ue}),Ue})),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define("underscore",t):(e="undefined"!=typeof globalThis?globalThis:e||self,function(){var n=e._,i=e._=t();i.noConflict=function(){return e._=n,i}}())}(this,(function(){var e="1.13.4",t="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},n=Array.prototype,i=Object.prototype,r="undefined"!=typeof Symbol?Symbol.prototype:null,s=n.push,o=n.slice,a=i.toString,u=i.hasOwnProperty,l="undefined"!=typeof ArrayBuffer,c="undefined"!=typeof DataView,h=Array.isArray,d=Object.keys,f=Object.create,p=l&&ArrayBuffer.isView,v=isNaN,g=isFinite,m=!{toString:null}.propertyIsEnumerable("toString"),y=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],w=Math.pow(2,53)-1;function b(e,t){return t=null==t?e.length-1:+t,function(){for(var n=Math.max(arguments.length-t,0),i=Array(n),r=0;r<n;r++)i[r]=arguments[r+t];switch(t){case 0:return e.call(this,i);case 1:return e.call(this,arguments[0],i);case 2:return e.call(this,arguments[0],arguments[1],i)}var s=Array(t+1);for(r=0;r<t;r++)s[r]=arguments[r];return s[t]=i,e.apply(this,s)}}function k(e){var t=typeof e;return"function"===t||"object"===t&&!!e}function _(e){return void 0===e}function x(e){return!0===e||!1===e||"[object Boolean]"===a.call(e)}function T(e){var t="[object "+e+"]";return function(e){return a.call(e)===t}}var C=T("String"),A=T("Number"),S=T("Date"),R=T("RegExp"),E=T("Error"),I=T("Symbol"),O=T("ArrayBuffer"),$=T("Function"),M=t.document&&t.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof M&&($=function(e){return"function"==typeof e||!1});var U=$,N=T("Object"),L=c&&N(new DataView(new ArrayBuffer(8))),P="undefined"!=typeof Map&&N(new Map),j=T("DataView");var B=L?function(e){return null!=e&&U(e.getInt8)&&O(e.buffer)}:j,W=h||T("Array");function D(e,t){return null!=e&&u.call(e,t)}var V=T("Arguments");!function(){V(arguments)||(V=function(e){return D(e,"callee")})}();var z=V;function F(e){return A(e)&&v(e)}function q(e){return function(){return e}}function H(e){return function(t){var n=e(t);return"number"==typeof n&&n>=0&&n<=w}}function J(e){return function(t){return null==t?void 0:t[e]}}var K=J("byteLength"),G=H(K),Y=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var X=l?function(e){return p?p(e)&&!B(e):G(e)&&Y.test(a.call(e))}:q(!1),Q=J("length");function Z(e,t){t=function(e){for(var t={},n=e.length,i=0;i<n;++i)t[e[i]]=!0;return{contains:function(e){return!0===t[e]},push:function(n){return t[n]=!0,e.push(n)}}}(t);var n=y.length,r=e.constructor,s=U(r)&&r.prototype||i,o="constructor";for(D(e,o)&&!t.contains(o)&&t.push(o);n--;)(o=y[n])in e&&e[o]!==s[o]&&!t.contains(o)&&t.push(o)}function ee(e){if(!k(e))return[];if(d)return d(e);var t=[];for(var n in e)D(e,n)&&t.push(n);return m&&Z(e,t),t}function te(e,t){var n=ee(t),i=n.length;if(null==e)return!i;for(var r=Object(e),s=0;s<i;s++){var o=n[s];if(t[o]!==r[o]||!(o in r))return!1}return!0}function ne(e){return e instanceof ne?e:this instanceof ne?void(this._wrapped=e):new ne(e)}function ie(e){return new Uint8Array(e.buffer||e,e.byteOffset||0,K(e))}ne.VERSION=e,ne.prototype.value=function(){return this._wrapped},ne.prototype.valueOf=ne.prototype.toJSON=ne.prototype.value,ne.prototype.toString=function(){return String(this._wrapped)};var re="[object DataView]";function se(e,t,n,i){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var r=typeof e;return("function"===r||"object"===r||"object"==typeof t)&&oe(e,t,n,i)}function oe(e,t,n,i){e instanceof ne&&(e=e._wrapped),t instanceof ne&&(t=t._wrapped);var s=a.call(e);if(s!==a.call(t))return!1;if(L&&"[object Object]"==s&&B(e)){if(!B(t))return!1;s=re}switch(s){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:0==+e?1/+e==1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object Symbol]":return r.valueOf.call(e)===r.valueOf.call(t);case"[object ArrayBuffer]":case re:return oe(ie(e),ie(t),n,i)}var o="[object Array]"===s;if(!o&&X(e)){if(K(e)!==K(t))return!1;if(e.buffer===t.buffer&&e.byteOffset===t.byteOffset)return!0;o=!0}if(!o){if("object"!=typeof e||"object"!=typeof t)return!1;var u=e.constructor,l=t.constructor;if(u!==l&&!(U(u)&&u instanceof u&&U(l)&&l instanceof l)&&"constructor"in e&&"constructor"in t)return!1}i=i||[];for(var c=(n=n||[]).length;c--;)if(n[c]===e)return i[c]===t;if(n.push(e),i.push(t),o){if((c=e.length)!==t.length)return!1;for(;c--;)if(!se(e[c],t[c],n,i))return!1}else{var h,d=ee(e);if(c=d.length,ee(t).length!==c)return!1;for(;c--;)if(!D(t,h=d[c])||!se(e[h],t[h],n,i))return!1}return n.pop(),i.pop(),!0}function ae(e){if(!k(e))return[];var t=[];for(var n in e)t.push(n);return m&&Z(e,t),t}function ue(e){var t=Q(e);return function(n){if(null==n)return!1;var i=ae(n);if(Q(i))return!1;for(var r=0;r<t;r++)if(!U(n[e[r]]))return!1;return e!==fe||!U(n[le])}}var le="forEach",ce=["clear","delete"],he=["get","has","set"],de=ce.concat(le,he),fe=ce.concat(he),pe=["add"].concat(ce,le,"has"),ve=P?ue(de):T("Map"),ge=P?ue(fe):T("WeakMap"),me=P?ue(pe):T("Set"),ye=T("WeakSet");function we(e){for(var t=ee(e),n=t.length,i=Array(n),r=0;r<n;r++)i[r]=e[t[r]];return i}function be(e){for(var t={},n=ee(e),i=0,r=n.length;i<r;i++)t[e[n[i]]]=n[i];return t}function ke(e){var t=[];for(var n in e)U(e[n])&&t.push(n);return t.sort()}function _e(e,t){return function(n){var i=arguments.length;if(t&&(n=Object(n)),i<2||null==n)return n;for(var r=1;r<i;r++)for(var s=arguments[r],o=e(s),a=o.length,u=0;u<a;u++){var l=o[u];t&&void 0!==n[l]||(n[l]=s[l])}return n}}var xe=_e(ae),Te=_e(ee),Ce=_e(ae,!0);function Ae(e){if(!k(e))return{};if(f)return f(e);var t=function(){};t.prototype=e;var n=new t;return t.prototype=null,n}function Se(e){return W(e)?e:[e]}function Re(e){return ne.toPath(e)}function Ee(e,t){for(var n=t.length,i=0;i<n;i++){if(null==e)return;e=e[t[i]]}return n?e:void 0}function Ie(e,t,n){var i=Ee(e,Re(t));return _(i)?n:i}function Oe(e){return e}function $e(e){return e=Te({},e),function(t){return te(t,e)}}function Me(e){return e=Re(e),function(t){return Ee(t,e)}}function Ue(e,t,n){if(void 0===t)return e;switch(null==n?3:n){case 1:return function(n){return e.call(t,n)};case 3:return function(n,i,r){return e.call(t,n,i,r)};case 4:return function(n,i,r,s){return e.call(t,n,i,r,s)}}return function(){return e.apply(t,arguments)}}function Ne(e,t,n){return null==e?Oe:U(e)?Ue(e,t,n):k(e)&&!W(e)?$e(e):Me(e)}function Le(e,t){return Ne(e,t,1/0)}function Pe(e,t,n){return ne.iteratee!==Le?ne.iteratee(e,t):Ne(e,t,n)}function je(){}function Be(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))}ne.toPath=Se,ne.iteratee=Le;var We=Date.now||function(){return(new Date).getTime()};function De(e){var t=function(t){return e[t]},n="(?:"+ee(e).join("|")+")",i=RegExp(n),r=RegExp(n,"g");return function(e){return e=null==e?"":""+e,i.test(e)?e.replace(r,t):e}}var Ve={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},ze=De(Ve),Fe=De(be(Ve)),qe=ne.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},He=/(.)^/,Je={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},Ke=/\\|'|\r|\n|\u2028|\u2029/g;function Ge(e){return"\\"+Je[e]}var Ye=/^\s*(\w|\$)+\s*$/;var Xe=0;function Qe(e,t,n,i,r){if(!(i instanceof t))return e.apply(n,r);var s=Ae(e.prototype),o=e.apply(s,r);return k(o)?o:s}var Ze=b((function(e,t){var n=Ze.placeholder,i=function(){for(var r=0,s=t.length,o=Array(s),a=0;a<s;a++)o[a]=t[a]===n?arguments[r++]:t[a];for(;r<arguments.length;)o.push(arguments[r++]);return Qe(e,i,this,this,o)};return i}));Ze.placeholder=ne;var et=b((function(e,t,n){if(!U(e))throw new TypeError("Bind must be called on a function");var i=b((function(r){return Qe(e,i,t,this,n.concat(r))}));return i})),tt=H(Q);function nt(e,t,n,i){if(i=i||[],t||0===t){if(t<=0)return i.concat(e)}else t=1/0;for(var r=i.length,s=0,o=Q(e);s<o;s++){var a=e[s];if(tt(a)&&(W(a)||z(a)))if(t>1)nt(a,t-1,n,i),r=i.length;else for(var u=0,l=a.length;u<l;)i[r++]=a[u++];else n||(i[r++]=a)}return i}var it=b((function(e,t){var n=(t=nt(t,!1,!1)).length;if(n<1)throw new Error("bindAll must be passed function names");for(;n--;){var i=t[n];e[i]=et(e[i],e)}return e}));var rt=b((function(e,t,n){return setTimeout((function(){return e.apply(null,n)}),t)})),st=Ze(rt,ne,1);function ot(e){return function(){return!e.apply(this,arguments)}}function at(e,t){var n;return function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=null),n}}var ut=Ze(at,2);function lt(e,t,n){t=Pe(t,n);for(var i,r=ee(e),s=0,o=r.length;s<o;s++)if(t(e[i=r[s]],i,e))return i}function ct(e){return function(t,n,i){n=Pe(n,i);for(var r=Q(t),s=e>0?0:r-1;s>=0&&s<r;s+=e)if(n(t[s],s,t))return s;return-1}}var ht=ct(1),dt=ct(-1);function ft(e,t,n,i){for(var r=(n=Pe(n,i,1))(t),s=0,o=Q(e);s<o;){var a=Math.floor((s+o)/2);n(e[a])<r?s=a+1:o=a}return s}function pt(e,t,n){return function(i,r,s){var a=0,u=Q(i);if("number"==typeof s)e>0?a=s>=0?s:Math.max(s+u,a):u=s>=0?Math.min(s+1,u):s+u+1;else if(n&&s&&u)return i[s=n(i,r)]===r?s:-1;if(r!=r)return(s=t(o.call(i,a,u),F))>=0?s+a:-1;for(s=e>0?a:u-1;s>=0&&s<u;s+=e)if(i[s]===r)return s;return-1}}var vt=pt(1,ht,ft),gt=pt(-1,dt);function mt(e,t,n){var i=(tt(e)?ht:lt)(e,t,n);if(void 0!==i&&-1!==i)return e[i]}function yt(e,t,n){var i,r;if(t=Ue(t,n),tt(e))for(i=0,r=e.length;i<r;i++)t(e[i],i,e);else{var s=ee(e);for(i=0,r=s.length;i<r;i++)t(e[s[i]],s[i],e)}return e}function wt(e,t,n){t=Pe(t,n);for(var i=!tt(e)&&ee(e),r=(i||e).length,s=Array(r),o=0;o<r;o++){var a=i?i[o]:o;s[o]=t(e[a],a,e)}return s}function bt(e){var t=function(t,n,i,r){var s=!tt(t)&&ee(t),o=(s||t).length,a=e>0?0:o-1;for(r||(i=t[s?s[a]:a],a+=e);a>=0&&a<o;a+=e){var u=s?s[a]:a;i=n(i,t[u],u,t)}return i};return function(e,n,i,r){var s=arguments.length>=3;return t(e,Ue(n,r,4),i,s)}}var kt=bt(1),_t=bt(-1);function xt(e,t,n){var i=[];return t=Pe(t,n),yt(e,(function(e,n,r){t(e,n,r)&&i.push(e)})),i}function Tt(e,t,n){t=Pe(t,n);for(var i=!tt(e)&&ee(e),r=(i||e).length,s=0;s<r;s++){var o=i?i[s]:s;if(!t(e[o],o,e))return!1}return!0}function Ct(e,t,n){t=Pe(t,n);for(var i=!tt(e)&&ee(e),r=(i||e).length,s=0;s<r;s++){var o=i?i[s]:s;if(t(e[o],o,e))return!0}return!1}function At(e,t,n,i){return tt(e)||(e=we(e)),("number"!=typeof n||i)&&(n=0),vt(e,t,n)>=0}var St=b((function(e,t,n){var i,r;return U(t)?r=t:(t=Re(t),i=t.slice(0,-1),t=t[t.length-1]),wt(e,(function(e){var s=r;if(!s){if(i&&i.length&&(e=Ee(e,i)),null==e)return;s=e[t]}return null==s?s:s.apply(e,n)}))}));function Rt(e,t){return wt(e,Me(t))}function Et(e,t,n){var i,r,s=-1/0,o=-1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var a=0,u=(e=tt(e)?e:we(e)).length;a<u;a++)null!=(i=e[a])&&i>s&&(s=i);else t=Pe(t,n),yt(e,(function(e,n,i){((r=t(e,n,i))>o||r===-1/0&&s===-1/0)&&(s=e,o=r)}));return s}var It=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function Ot(e){return e?W(e)?o.call(e):C(e)?e.match(It):tt(e)?wt(e,Oe):we(e):[]}function $t(e,t,n){if(null==t||n)return tt(e)||(e=we(e)),e[Be(e.length-1)];var i=Ot(e),r=Q(i);t=Math.max(Math.min(t,r),0);for(var s=r-1,o=0;o<t;o++){var a=Be(o,s),u=i[o];i[o]=i[a],i[a]=u}return i.slice(0,t)}function Mt(e,t){return function(n,i,r){var s=t?[[],[]]:{};return i=Pe(i,r),yt(n,(function(t,r){var o=i(t,r,n);e(s,t,o)})),s}}var Ut=Mt((function(e,t,n){D(e,n)?e[n].push(t):e[n]=[t]})),Nt=Mt((function(e,t,n){e[n]=t})),Lt=Mt((function(e,t,n){D(e,n)?e[n]++:e[n]=1})),Pt=Mt((function(e,t,n){e[n?0:1].push(t)}),!0);function jt(e,t,n){return t in n}var Bt=b((function(e,t){var n={},i=t[0];if(null==e)return n;U(i)?(t.length>1&&(i=Ue(i,t[1])),t=ae(e)):(i=jt,t=nt(t,!1,!1),e=Object(e));for(var r=0,s=t.length;r<s;r++){var o=t[r],a=e[o];i(a,o,e)&&(n[o]=a)}return n})),Wt=b((function(e,t){var n,i=t[0];return U(i)?(i=ot(i),t.length>1&&(n=t[1])):(t=wt(nt(t,!1,!1),String),i=function(e,n){return!At(t,n)}),Bt(e,i,n)}));function Dt(e,t,n){return o.call(e,0,Math.max(0,e.length-(null==t||n?1:t)))}function Vt(e,t,n){return null==e||e.length<1?null==t||n?void 0:[]:null==t||n?e[0]:Dt(e,e.length-t)}function zt(e,t,n){return o.call(e,null==t||n?1:t)}var Ft=b((function(e,t){return t=nt(t,!0,!0),xt(e,(function(e){return!At(t,e)}))})),qt=b((function(e,t){return Ft(e,t)}));function Ht(e,t,n,i){x(t)||(i=n,n=t,t=!1),null!=n&&(n=Pe(n,i));for(var r=[],s=[],o=0,a=Q(e);o<a;o++){var u=e[o],l=n?n(u,o,e):u;t&&!n?(o&&s===l||r.push(u),s=l):n?At(s,l)||(s.push(l),r.push(u)):At(r,u)||r.push(u)}return r}var Jt=b((function(e){return Ht(nt(e,!0,!0))}));function Kt(e){for(var t=e&&Et(e,Q).length||0,n=Array(t),i=0;i<t;i++)n[i]=Rt(e,i);return n}var Gt=b(Kt);function Yt(e,t){return e._chain?ne(t).chain():t}function Xt(e){return yt(ke(e),(function(t){var n=ne[t]=e[t];ne.prototype[t]=function(){var e=[this._wrapped];return s.apply(e,arguments),Yt(this,n.apply(ne,e))}})),ne}yt(["pop","push","reverse","shift","sort","splice","unshift"],(function(e){var t=n[e];ne.prototype[e]=function(){var n=this._wrapped;return null!=n&&(t.apply(n,arguments),"shift"!==e&&"splice"!==e||0!==n.length||delete n[0]),Yt(this,n)}})),yt(["concat","join","slice"],(function(e){var t=n[e];ne.prototype[e]=function(){var e=this._wrapped;return null!=e&&(e=t.apply(e,arguments)),Yt(this,e)}}));var Qt={__proto__:null,VERSION:e,restArguments:b,isObject:k,isNull:function(e){return null===e},isUndefined:_,isBoolean:x,isElement:function(e){return!(!e||1!==e.nodeType)},isString:C,isNumber:A,isDate:S,isRegExp:R,isError:E,isSymbol:I,isArrayBuffer:O,isDataView:B,isArray:W,isFunction:U,isArguments:z,isFinite:function(e){return!I(e)&&g(e)&&!isNaN(parseFloat(e))},isNaN:F,isTypedArray:X,isEmpty:function(e){if(null==e)return!0;var t=Q(e);return"number"==typeof t&&(W(e)||C(e)||z(e))?0===t:0===Q(ee(e))},isMatch:te,isEqual:function(e,t){return se(e,t)},isMap:ve,isWeakMap:ge,isSet:me,isWeakSet:ye,keys:ee,allKeys:ae,values:we,pairs:function(e){for(var t=ee(e),n=t.length,i=Array(n),r=0;r<n;r++)i[r]=[t[r],e[t[r]]];return i},invert:be,functions:ke,methods:ke,extend:xe,extendOwn:Te,assign:Te,defaults:Ce,create:function(e,t){var n=Ae(e);return t&&Te(n,t),n},clone:function(e){return k(e)?W(e)?e.slice():xe({},e):e},tap:function(e,t){return t(e),e},get:Ie,has:function(e,t){for(var n=(t=Re(t)).length,i=0;i<n;i++){var r=t[i];if(!D(e,r))return!1;e=e[r]}return!!n},mapObject:function(e,t,n){t=Pe(t,n);for(var i=ee(e),r=i.length,s={},o=0;o<r;o++){var a=i[o];s[a]=t(e[a],a,e)}return s},identity:Oe,constant:q,noop:je,toPath:Se,property:Me,propertyOf:function(e){return null==e?je:function(t){return Ie(e,t)}},matcher:$e,matches:$e,times:function(e,t,n){var i=Array(Math.max(0,e));t=Ue(t,n,1);for(var r=0;r<e;r++)i[r]=t(r);return i},random:Be,now:We,escape:ze,unescape:Fe,templateSettings:qe,template:function(e,t,n){!t&&n&&(t=n),t=Ce({},t,ne.templateSettings);var i=RegExp([(t.escape||He).source,(t.interpolate||He).source,(t.evaluate||He).source].join("|")+"|$","g"),r=0,s="__p+='";e.replace(i,(function(t,n,i,o,a){return s+=e.slice(r,a).replace(Ke,Ge),r=a+t.length,n?s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":i?s+="'+\n((__t=("+i+"))==null?'':__t)+\n'":o&&(s+="';\n"+o+"\n__p+='"),t})),s+="';\n";var o,a=t.variable;if(a){if(!Ye.test(a))throw new Error("variable is not a bare identifier: "+a)}else s="with(obj||{}){\n"+s+"}\n",a="obj";s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{o=new Function(a,"_",s)}catch(e){throw e.source=s,e}var u=function(e){return o.call(this,e,ne)};return u.source="function("+a+"){\n"+s+"}",u},result:function(e,t,n){var i=(t=Re(t)).length;if(!i)return U(n)?n.call(e):n;for(var r=0;r<i;r++){var s=null==e?void 0:e[t[r]];void 0===s&&(s=n,r=i),e=U(s)?s.call(e):s}return e},uniqueId:function(e){var t=++Xe+"";return e?e+t:t},chain:function(e){var t=ne(e);return t._chain=!0,t},iteratee:Le,partial:Ze,bind:et,bindAll:it,memoize:function(e,t){var n=function(i){var r=n.cache,s=""+(t?t.apply(this,arguments):i);return D(r,s)||(r[s]=e.apply(this,arguments)),r[s]};return n.cache={},n},delay:rt,defer:st,throttle:function(e,t,n){var i,r,s,o,a=0;n||(n={});var u=function(){a=!1===n.leading?0:We(),i=null,o=e.apply(r,s),i||(r=s=null)},l=function(){var l=We();a||!1!==n.leading||(a=l);var c=t-(l-a);return r=this,s=arguments,c<=0||c>t?(i&&(clearTimeout(i),i=null),a=l,o=e.apply(r,s),i||(r=s=null)):i||!1===n.trailing||(i=setTimeout(u,c)),o};return l.cancel=function(){clearTimeout(i),a=0,i=r=s=null},l},debounce:function(e,t,n){var i,r,s,o,a,u=function(){var l=We()-r;t>l?i=setTimeout(u,t-l):(i=null,n||(o=e.apply(a,s)),i||(s=a=null))},l=b((function(l){return a=this,s=l,r=We(),i||(i=setTimeout(u,t),n&&(o=e.apply(a,s))),o}));return l.cancel=function(){clearTimeout(i),i=s=a=null},l},wrap:function(e,t){return Ze(t,e)},negate:ot,compose:function(){var e=arguments,t=e.length-1;return function(){for(var n=t,i=e[t].apply(this,arguments);n--;)i=e[n].call(this,i);return i}},after:function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},before:at,once:ut,findKey:lt,findIndex:ht,findLastIndex:dt,sortedIndex:ft,indexOf:vt,lastIndexOf:gt,find:mt,detect:mt,findWhere:function(e,t){return mt(e,$e(t))},each:yt,forEach:yt,map:wt,collect:wt,reduce:kt,foldl:kt,inject:kt,reduceRight:_t,foldr:_t,filter:xt,select:xt,reject:function(e,t,n){return xt(e,ot(Pe(t)),n)},every:Tt,all:Tt,some:Ct,any:Ct,contains:At,includes:At,include:At,invoke:St,pluck:Rt,where:function(e,t){return xt(e,$e(t))},max:Et,min:function(e,t,n){var i,r,s=1/0,o=1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var a=0,u=(e=tt(e)?e:we(e)).length;a<u;a++)null!=(i=e[a])&&i<s&&(s=i);else t=Pe(t,n),yt(e,(function(e,n,i){((r=t(e,n,i))<o||r===1/0&&s===1/0)&&(s=e,o=r)}));return s},shuffle:function(e){return $t(e,1/0)},sample:$t,sortBy:function(e,t,n){var i=0;return t=Pe(t,n),Rt(wt(e,(function(e,n,r){return{value:e,index:i++,criteria:t(e,n,r)}})).sort((function(e,t){var n=e.criteria,i=t.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(n<i||void 0===i)return-1}return e.index-t.index})),"value")},groupBy:Ut,indexBy:Nt,countBy:Lt,partition:Pt,toArray:Ot,size:function(e){return null==e?0:tt(e)?e.length:ee(e).length},pick:Bt,omit:Wt,first:Vt,head:Vt,take:Vt,initial:Dt,last:function(e,t,n){return null==e||e.length<1?null==t||n?void 0:[]:null==t||n?e[e.length-1]:zt(e,Math.max(0,e.length-t))},rest:zt,tail:zt,drop:zt,compact:function(e){return xt(e,Boolean)},flatten:function(e,t){return nt(e,t,!1)},without:qt,uniq:Ht,unique:Ht,union:Jt,intersection:function(e){for(var t=[],n=arguments.length,i=0,r=Q(e);i<r;i++){var s=e[i];if(!At(t,s)){var o;for(o=1;o<n&&At(arguments[o],s);o++);o===n&&t.push(s)}}return t},difference:Ft,unzip:Kt,transpose:Kt,zip:Gt,object:function(e,t){for(var n={},i=0,r=Q(e);i<r;i++)t?n[e[i]]=t[i]:n[e[i][0]]=e[i][1];return n},range:function(e,t,n){null==t&&(t=e||0,e=0),n||(n=t<e?-1:1);for(var i=Math.max(Math.ceil((t-e)/n),0),r=Array(i),s=0;s<i;s++,e+=n)r[s]=e;return r},chunk:function(e,t){if(null==t||t<1)return[];for(var n=[],i=0,r=e.length;i<r;)n.push(o.call(e,i,i+=t));return n},mixin:Xt,default:ne},Zt=Xt(Qt);return Zt._=Zt,Zt})),function(e){var t="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global;if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],(function(n,i,r){t.Backbone=e(t,r,n,i)}));else if("undefined"!=typeof exports){var n,i=require("underscore");try{n=require("jquery")}catch(e){}e(t,exports,i,n)}else t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}((function(e,t,n,i){var r=e.Backbone,s=Array.prototype.slice;t.VERSION="1.4.1",t.$=i,t.noConflict=function(){return e.Backbone=r,this},t.emulateHTTP=!1,t.emulateJSON=!1;var o,a=t.Events={},u=/\s+/,l=function(e,t,i,r,s){var o,a=0;if(i&&"object"==typeof i){void 0!==r&&"context"in s&&void 0===s.context&&(s.context=r);for(o=n.keys(i);a<o.length;a++)t=l(e,t,o[a],i[o[a]],s)}else if(i&&u.test(i))for(o=i.split(u);a<o.length;a++)t=e(t,o[a],r,s);else t=e(t,i,r,s);return t};a.on=function(e,t,n){(this._events=l(c,this._events||{},e,t,{context:n,ctx:this,listening:o}),o)&&((this._listeners||(this._listeners={}))[o.id]=o,o.interop=!1);return this},a.listenTo=function(e,t,i){if(!e)return this;var r=e._listenId||(e._listenId=n.uniqueId("l")),s=this._listeningTo||(this._listeningTo={}),a=o=s[r];a||(this._listenId||(this._listenId=n.uniqueId("l")),a=o=s[r]=new g(this,e));var u=h(e,t,i,this);if(o=void 0,u)throw u;return a.interop&&a.on(t,i),this};var c=function(e,t,n,i){if(n){var r=e[t]||(e[t]=[]),s=i.context,o=i.ctx,a=i.listening;a&&a.count++,r.push({callback:n,context:s,ctx:s||o,listening:a})}return e},h=function(e,t,n,i){try{e.on(t,n,i)}catch(e){return e}};a.off=function(e,t,n){return this._events?(this._events=l(d,this._events,e,t,{context:n,listeners:this._listeners}),this):this},a.stopListening=function(e,t,i){var r=this._listeningTo;if(!r)return this;for(var s=e?[e._listenId]:n.keys(r),o=0;o<s.length;o++){var a=r[s[o]];if(!a)break;a.obj.off(t,i,this),a.interop&&a.off(t,i)}return n.isEmpty(r)&&(this._listeningTo=void 0),this};var d=function(e,t,i,r){if(e){var s,o=r.context,a=r.listeners,u=0;if(t||o||i){for(s=t?[t]:n.keys(e);u<s.length;u++){var l=e[t=s[u]];if(!l)break;for(var c=[],h=0;h<l.length;h++){var d=l[h];if(i&&i!==d.callback&&i!==d.callback._callback||o&&o!==d.context)c.push(d);else{var f=d.listening;f&&f.off(t,i)}}c.length?e[t]=c:delete e[t]}return e}for(s=n.keys(a);u<s.length;u++)a[s[u]].cleanup()}};a.once=function(e,t,n){var i=l(f,{},e,t,this.off.bind(this));return"string"==typeof e&&null==n&&(t=void 0),this.on(i,t,n)},a.listenToOnce=function(e,t,n){var i=l(f,{},t,n,this.stopListening.bind(this,e));return this.listenTo(e,i)};var f=function(e,t,i,r){if(i){var s=e[t]=n.once((function(){r(t,s),i.apply(this,arguments)}));s._callback=i}return e};a.trigger=function(e){if(!this._events)return this;for(var t=Math.max(0,arguments.length-1),n=Array(t),i=0;i<t;i++)n[i]=arguments[i+1];return l(p,this._events,e,void 0,n),this};var p=function(e,t,n,i){if(e){var r=e[t],s=e.all;r&&s&&(s=s.slice()),r&&v(r,i),s&&v(s,[t].concat(i))}return e},v=function(e,t){var n,i=-1,r=e.length,s=t[0],o=t[1],a=t[2];switch(t.length){case 0:for(;++i<r;)(n=e[i]).callback.call(n.ctx);return;case 1:for(;++i<r;)(n=e[i]).callback.call(n.ctx,s);return;case 2:for(;++i<r;)(n=e[i]).callback.call(n.ctx,s,o);return;case 3:for(;++i<r;)(n=e[i]).callback.call(n.ctx,s,o,a);return;default:for(;++i<r;)(n=e[i]).callback.apply(n.ctx,t);return}},g=function(e,t){this.id=e._listenId,this.listener=e,this.obj=t,this.interop=!0,this.count=0,this._events=void 0};g.prototype.on=a.on,g.prototype.off=function(e,t){var n;this.interop?(this._events=l(d,this._events,e,t,{context:void 0,listeners:void 0}),n=!this._events):(this.count--,n=0===this.count),n&&this.cleanup()},g.prototype.cleanup=function(){delete this.listener._listeningTo[this.obj._listenId],this.interop||delete this.obj._listeners[this.id]},a.bind=a.on,a.unbind=a.off,n.extend(t,a);var m=t.Model=function(e,t){var i=e||{};t||(t={}),this.preinitialize.apply(this,arguments),this.cid=n.uniqueId(this.cidPrefix),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(i=this.parse(i,t)||{});var r=n.result(this,"defaults");i=n.defaults(n.extend({},r,i),r),this.set(i,t),this.changed={},this.initialize.apply(this,arguments)};n.extend(m.prototype,a,{changed:null,validationError:null,idAttribute:"id",cidPrefix:"c",preinitialize:function(){},initialize:function(){},toJSON:function(e){return n.clone(this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return n.escape(this.get(e))},has:function(e){return null!=this.get(e)},matches:function(e){return!!n.iteratee(e,this)(this.attributes)},set:function(e,t,i){if(null==e)return this;var r;if("object"==typeof e?(r=e,i=t):(r={})[e]=t,i||(i={}),!this._validate(r,i))return!1;var s=i.unset,o=i.silent,a=[],u=this._changing;this._changing=!0,u||(this._previousAttributes=n.clone(this.attributes),this.changed={});var l=this.attributes,c=this.changed,h=this._previousAttributes;for(var d in r)t=r[d],n.isEqual(l[d],t)||a.push(d),n.isEqual(h[d],t)?delete c[d]:c[d]=t,s?delete l[d]:l[d]=t;if(this.idAttribute in r){var f=this.id;this.id=this.get(this.idAttribute),this.trigger("changeId",this,f,i)}if(!o){a.length&&(this._pending=i);for(var p=0;p<a.length;p++)this.trigger("change:"+a[p],this,l[a[p]],i)}if(u)return this;if(!o)for(;this._pending;)i=this._pending,this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,n.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var i in this.attributes)t[i]=void 0;return this.set(t,n.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!n.isEmpty(this.changed):n.has(this.changed,e)},changedAttributes:function(e){if(!e)return!!this.hasChanged()&&n.clone(this.changed);var t,i=this._changing?this._previousAttributes:this.attributes,r={};for(var s in e){var o=e[s];n.isEqual(i[s],o)||(r[s]=o,t=!0)}return!!t&&r},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return n.clone(this._previousAttributes)},fetch:function(e){e=n.extend({parse:!0},e);var t=this,i=e.success;return e.success=function(n){var r=e.parse?t.parse(n,e):n;if(!t.set(r,e))return!1;i&&i.call(e.context,t,n,e),t.trigger("sync",t,n,e)},F(this,e),this.sync("read",this,e)},save:function(e,t,i){var r;null==e||"object"==typeof e?(r=e,i=t):(r={})[e]=t;var s=(i=n.extend({validate:!0,parse:!0},i)).wait;if(r&&!s){if(!this.set(r,i))return!1}else if(!this._validate(r,i))return!1;var o=this,a=i.success,u=this.attributes;i.success=function(e){o.attributes=u;var t=i.parse?o.parse(e,i):e;if(s&&(t=n.extend({},r,t)),t&&!o.set(t,i))return!1;a&&a.call(i.context,o,e,i),o.trigger("sync",o,e,i)},F(this,i),r&&s&&(this.attributes=n.extend({},u,r));var l=this.isNew()?"create":i.patch?"patch":"update";"patch"!==l||i.attrs||(i.attrs=r);var c=this.sync(l,this,i);return this.attributes=u,c},destroy:function(e){e=e?n.clone(e):{};var t=this,i=e.success,r=e.wait,s=function(){t.stopListening(),t.trigger("destroy",t,t.collection,e)};e.success=function(n){r&&s(),i&&i.call(e.context,t,n,e),t.isNew()||t.trigger("sync",t,n,e)};var o=!1;return this.isNew()?n.defer(e.success):(F(this,e),o=this.sync("delete",this,e)),r||s(),o},url:function(){var e=n.result(this,"urlRoot")||n.result(this.collection,"url")||z();if(this.isNew())return e;var t=this.get(this.idAttribute);return e.replace(/[^\/]$/,"$&/")+encodeURIComponent(t)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(e){return this._validate({},n.extend({},e,{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=n.extend({},this.attributes,e);var i=this.validationError=this.validate(e,t)||null;return!i||(this.trigger("invalid",this,i,n.extend(t,{validationError:i})),!1)}});var y=t.Collection=function(e,t){t||(t={}),this.preinitialize.apply(this,arguments),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,n.extend({silent:!0},t))},w={add:!0,remove:!0,merge:!0},b={add:!0,remove:!1},k=function(e,t,n){n=Math.min(Math.max(n,0),e.length);var i,r=Array(e.length-n),s=t.length;for(i=0;i<r.length;i++)r[i]=e[i+n];for(i=0;i<s;i++)e[i+n]=t[i];for(i=0;i<r.length;i++)e[i+s+n]=r[i]};n.extend(y.prototype,a,{model:m,preinitialize:function(){},initialize:function(){},toJSON:function(e){return this.map((function(t){return t.toJSON(e)}))},sync:function(){return t.sync.apply(this,arguments)},add:function(e,t){return this.set(e,n.extend({merge:!1},t,b))},remove:function(e,t){t=n.extend({},t);var i=!n.isArray(e);e=i?[e]:e.slice();var r=this._removeModels(e,t);return!t.silent&&r.length&&(t.changes={added:[],merged:[],removed:r},this.trigger("update",this,t)),i?r[0]:r},set:function(e,t){if(null!=e){(t=n.extend({},w,t)).parse&&!this._isModel(e)&&(e=this.parse(e,t)||[]);var i=!n.isArray(e);e=i?[e]:e.slice();var r=t.at;null!=r&&(r=+r),r>this.length&&(r=this.length),r<0&&(r+=this.length+1);var s,o,a=[],u=[],l=[],c=[],h={},d=t.add,f=t.merge,p=t.remove,v=!1,g=this.comparator&&null==r&&!1!==t.sort,m=n.isString(this.comparator)?this.comparator:null;for(o=0;o<e.length;o++){s=e[o];var y=this.get(s);if(y){if(f&&s!==y){var b=this._isModel(s)?s.attributes:s;t.parse&&(b=y.parse(b,t)),y.set(b,t),l.push(y),g&&!v&&(v=y.hasChanged(m))}h[y.cid]||(h[y.cid]=!0,a.push(y)),e[o]=y}else d&&(s=e[o]=this._prepareModel(s,t))&&(u.push(s),this._addReference(s,t),h[s.cid]=!0,a.push(s))}if(p){for(o=0;o<this.length;o++)h[(s=this.models[o]).cid]||c.push(s);c.length&&this._removeModels(c,t)}var _=!1,x=!g&&d&&p;if(a.length&&x?(_=this.length!==a.length||n.some(this.models,(function(e,t){return e!==a[t]})),this.models.length=0,k(this.models,a,0),this.length=this.models.length):u.length&&(g&&(v=!0),k(this.models,u,null==r?this.length:r),this.length=this.models.length),v&&this.sort({silent:!0}),!t.silent){for(o=0;o<u.length;o++)null!=r&&(t.index=r+o),(s=u[o]).trigger("add",s,this,t);(v||_)&&this.trigger("sort",this,t),(u.length||c.length||l.length)&&(t.changes={added:u,removed:c,merged:l},this.trigger("update",this,t))}return i?e[0]:e}},reset:function(e,t){t=t?n.clone(t):{};for(var i=0;i<this.models.length;i++)this._removeReference(this.models[i],t);return t.previousModels=this.models,this._reset(),e=this.add(e,n.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),e},push:function(e,t){return this.add(e,n.extend({at:this.length},t))},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e)},unshift:function(e,t){return this.add(e,n.extend({at:0},t))},shift:function(e){var t=this.at(0);return this.remove(t,e)},slice:function(){return s.apply(this.models,arguments)},get:function(e){if(null!=e)return this._byId[e]||this._byId[this.modelId(this._isModel(e)?e.attributes:e,e.idAttribute)]||e.cid&&this._byId[e.cid]},has:function(e){return null!=this.get(e)},at:function(e){return e<0&&(e+=this.length),this.models[e]},where:function(e,t){return this[t?"find":"filter"](e)},findWhere:function(e){return this.where(e,!0)},sort:function(e){var t=this.comparator;if(!t)throw new Error("Cannot sort a set without a comparator");e||(e={});var i=t.length;return n.isFunction(t)&&(t=t.bind(this)),1===i||n.isString(t)?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("sort",this,e),this},pluck:function(e){return this.map(e+"")},fetch:function(e){var t=(e=n.extend({parse:!0},e)).success,i=this;return e.success=function(n){var r=e.reset?"reset":"set";i[r](n,e),t&&t.call(e.context,i,n,e),i.trigger("sync",i,n,e)},F(this,e),this.sync("read",this,e)},create:function(e,t){var i=(t=t?n.clone(t):{}).wait;if(!(e=this._prepareModel(e,t)))return!1;i||this.add(e,t);var r=this,s=t.success;return t.success=function(e,t,n){i&&r.add(e,n),s&&s.call(n.context,e,t,n)},e.save(null,t),e},parse:function(e,t){return e},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(e,t){return e[t||this.model.prototype.idAttribute||"id"]},values:function(){return new x(this,T)},keys:function(){return new x(this,C)},entries:function(){return new x(this,A)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){return this._isModel(e)?(e.collection||(e.collection=this),e):((t=t?n.clone(t):{}).collection=this,(i=this.model.prototype?new this.model(e,t):this.model(e,t)).validationError?(this.trigger("invalid",this,i.validationError,t),!1):i);var i},_removeModels:function(e,t){for(var n=[],i=0;i<e.length;i++){var r=this.get(e[i]);if(r){var s=this.indexOf(r);this.models.splice(s,1),this.length--,delete this._byId[r.cid];var o=this.modelId(r.attributes,r.idAttribute);null!=o&&delete this._byId[o],t.silent||(t.index=s,r.trigger("remove",r,this,t)),n.push(r),this._removeReference(r,t)}}return n},_isModel:function(e){return e instanceof m},_addReference:function(e,t){this._byId[e.cid]=e;var n=this.modelId(e.attributes,e.idAttribute);null!=n&&(this._byId[n]=e),e.on("all",this._onModelEvent,this)},_removeReference:function(e,t){delete this._byId[e.cid];var n=this.modelId(e.attributes,e.idAttribute);null!=n&&delete this._byId[n],this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,i){if(t){if(("add"===e||"remove"===e)&&n!==this)return;if("destroy"===e&&this.remove(t,i),"changeId"===e){var r=this.modelId(t.previousAttributes(),t.idAttribute),s=this.modelId(t.attributes,t.idAttribute);null!=r&&delete this._byId[r],null!=s&&(this._byId[s]=t)}}this.trigger.apply(this,arguments)}});var _="function"==typeof Symbol&&Symbol.iterator;_&&(y.prototype[_]=y.prototype.values);var x=function(e,t){this._collection=e,this._kind=t,this._index=0},T=1,C=2,A=3;_&&(x.prototype[_]=function(){return this}),x.prototype.next=function(){if(this._collection){if(this._index<this._collection.length){var e,t=this._collection.at(this._index);if(this._index++,this._kind===T)e=t;else{var n=this._collection.modelId(t.attributes,t.idAttribute);e=this._kind===C?n:[n,t]}return{value:e,done:!1}}this._collection=void 0}return{value:void 0,done:!0}};var S=t.View=function(e){this.cid=n.uniqueId("view"),this.preinitialize.apply(this,arguments),n.extend(this,n.pick(e,E)),this._ensureElement(),this.initialize.apply(this,arguments)},R=/^(\S+)\s*(.*)$/,E=["model","collection","el","id","attributes","className","tagName","events"];n.extend(S.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},preinitialize:function(){},initialize:function(){},render:function(){return this},remove:function(){return this._removeElement(),this.stopListening(),this},_removeElement:function(){this.$el.remove()},setElement:function(e){return this.undelegateEvents(),this._setElement(e),this.delegateEvents(),this},_setElement:function(e){this.$el=e instanceof t.$?e:t.$(e),this.el=this.$el[0]},delegateEvents:function(e){if(e||(e=n.result(this,"events")),!e)return this;for(var t in this.undelegateEvents(),e){var i=e[t];if(n.isFunction(i)||(i=this[i]),i){var r=t.match(R);this.delegate(r[1],r[2],i.bind(this))}}return this},delegate:function(e,t,n){return this.$el.on(e+".delegateEvents"+this.cid,t,n),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this},undelegate:function(e,t,n){return this.$el.off(e+".delegateEvents"+this.cid,t,n),this},_createElement:function(e){return document.createElement(e)},_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"));else{var e=n.extend({},n.result(this,"attributes"));this.id&&(e.id=n.result(this,"id")),this.className&&(e.class=n.result(this,"className")),this.setElement(this._createElement(n.result(this,"tagName"))),this._setAttributes(e)}},_setAttributes:function(e){this.$el.attr(e)}});var I=function(e,t,i,r){n.each(i,(function(n,i){t[i]&&(e.prototype[i]=function(e,t,n,i){switch(t){case 1:return function(){return e[n](this[i])};case 2:return function(t){return e[n](this[i],t)};case 3:return function(t,r){return e[n](this[i],O(t,this),r)};case 4:return function(t,r,s){return e[n](this[i],O(t,this),r,s)};default:return function(){var t=s.call(arguments);return t.unshift(this[i]),e[n].apply(e,t)}}}(t,n,i,r))}))},O=function(e,t){return n.isFunction(e)?e:n.isObject(e)&&!t._isModel(e)?$(e):n.isString(e)?function(t){return t.get(e)}:e},$=function(e){var t=n.matches(e);return function(e){return t(e.attributes)}};n.each([[y,{forEach:3,each:3,map:3,collect:3,reduce:0,foldl:0,inject:0,reduceRight:0,foldr:0,find:3,detect:3,filter:3,select:3,reject:3,every:3,all:3,some:3,any:3,include:3,includes:3,contains:3,invoke:0,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3,groupBy:3,countBy:3,sortBy:3,indexBy:3,findIndex:3,findLastIndex:3},"models"],[m,{keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1},"attributes"]],(function(e){var t=e[0],i=e[1],r=e[2];t.mixin=function(e){var i=n.reduce(n.functions(e),(function(e,t){return e[t]=0,e}),{});I(t,e,i,r)},I(t,n,i,r)})),t.sync=function(e,i,r){var s=M[e];n.defaults(r||(r={}),{emulateHTTP:t.emulateHTTP,emulateJSON:t.emulateJSON});var o={type:s,dataType:"json"};if(r.url||(o.url=n.result(i,"url")||z()),null!=r.data||!i||"create"!==e&&"update"!==e&&"patch"!==e||(o.contentType="application/json",o.data=JSON.stringify(r.attrs||i.toJSON(r))),r.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),r.emulateHTTP&&("PUT"===s||"DELETE"===s||"PATCH"===s)){o.type="POST",r.emulateJSON&&(o.data._method=s);var a=r.beforeSend;r.beforeSend=function(e){if(e.setRequestHeader("X-HTTP-Method-Override",s),a)return a.apply(this,arguments)}}"GET"===o.type||r.emulateJSON||(o.processData=!1);var u=r.error;r.error=function(e,t,n){r.textStatus=t,r.errorThrown=n,u&&u.call(r.context,e,t,n)};var l=r.xhr=t.ajax(n.extend(o,r));return i.trigger("request",i,l,r),l};var M={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};t.ajax=function(){return t.$.ajax.apply(t.$,arguments)};var U=t.Router=function(e){e||(e={}),this.preinitialize.apply(this,arguments),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},N=/\((.*?)\)/g,L=/(\(\?)?:\w+/g,P=/\*\w+/g,j=/[\-{}\[\]+?.,\\\^$|#\s]/g;n.extend(U.prototype,a,{preinitialize:function(){},initialize:function(){},route:function(e,i,r){n.isRegExp(e)||(e=this._routeToRegExp(e)),n.isFunction(i)&&(r=i,i=""),r||(r=this[i]);var s=this;return t.history.route(e,(function(n){var o=s._extractParameters(e,n);!1!==s.execute(r,o,i)&&(s.trigger.apply(s,["route:"+i].concat(o)),s.trigger("route",i,o),t.history.trigger("route",s,i,o))})),this},execute:function(e,t,n){e&&e.apply(this,t)},navigate:function(e,n){return t.history.navigate(e,n),this},_bindRoutes:function(){if(this.routes){this.routes=n.result(this,"routes");for(var e,t=n.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(j,"\\$&").replace(N,"(?:$1)?").replace(L,(function(e,t){return t?e:"([^/?]+)"})).replace(P,"([^?]*?)"),new RegExp("^"+e+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(e,t){var i=e.exec(t).slice(1);return n.map(i,(function(e,t){return t===i.length-1?e||null:e?decodeURIComponent(e):null}))}});var B=t.History=function(){this.handlers=[],this.checkUrl=this.checkUrl.bind(this),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},W=/^[#\/]|\s+$/g,D=/^\/+|\/+$/g,V=/#.*$/;B.started=!1,n.extend(B.prototype,a,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root&&!this.getSearch()},matchRoot:function(){return this.decodeFragment(this.location.pathname).slice(0,this.root.length-1)+"/"===this.root},decodeFragment:function(e){return decodeURI(e.replace(/%25/g,"%2525"))},getSearch:function(){var e=this.location.href.replace(/#.*/,"").match(/\?.+/);return e?e[0]:""},getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getPath:function(){var e=this.decodeFragment(this.location.pathname+this.getSearch()).slice(this.root.length-1);return"/"===e.charAt(0)?e.slice(1):e},getFragment:function(e){return null==e&&(e=this._usePushState||!this._wantsHashChange?this.getPath():this.getHash()),e.replace(W,"")},start:function(e){if(B.started)throw new Error("Backbone.history has already been started");if(B.started=!0,this.options=n.extend({root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=!1!==this.options.hashChange,this._hasHashChange="onhashchange"in window&&(void 0===document.documentMode||document.documentMode>7),this._useHashChange=this._wantsHashChange&&this._hasHashChange,this._wantsPushState=!!this.options.pushState,this._hasPushState=!(!this.history||!this.history.pushState),this._usePushState=this._wantsPushState&&this._hasPushState,this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(D,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var t=this.root.slice(0,-1)||"/";return this.location.replace(t+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!this._hasHashChange&&this._wantsHashChange&&!this._usePushState){this.iframe=document.createElement("iframe"),this.iframe.src="javascript:0",this.iframe.style.display="none",this.iframe.tabIndex=-1;var i=document.body,r=i.insertBefore(this.iframe,i.firstChild).contentWindow;r.document.open(),r.document.close(),r.location.hash="#"+this.fragment}var s=window.addEventListener||function(e,t){return attachEvent("on"+e,t)};if(this._usePushState?s("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe?s("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),!this.options.silent)return this.loadUrl()},stop:function(){var e=window.removeEventListener||function(e,t){return detachEvent("on"+e,t)};this._usePushState?e("popstate",this.checkUrl,!1):this._useHashChange&&!this.iframe&&e("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),B.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();if(t===this.fragment&&this.iframe&&(t=this.getHash(this.iframe.contentWindow)),t===this.fragment)return!1;this.iframe&&this.navigate(t),this.loadUrl()},loadUrl:function(e){return!!this.matchRoot()&&(e=this.fragment=this.getFragment(e),n.some(this.handlers,(function(t){if(t.route.test(e))return t.callback(e),!0})))},navigate:function(e,t){if(!B.started)return!1;t&&!0!==t||(t={trigger:!!t}),e=this.getFragment(e||"");var n=this.root;""!==e&&"?"!==e.charAt(0)||(n=n.slice(0,-1)||"/");var i=n+e;e=e.replace(V,"");var r=this.decodeFragment(e);if(this.fragment!==r){if(this.fragment=r,this._usePushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);if(this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getHash(this.iframe.contentWindow)){var s=this.iframe.contentWindow;t.replace||(s.document.open(),s.document.close()),this._updateHash(s.location,e,t.replace)}}return t.trigger?this.loadUrl(e):void 0}},_updateHash:function(e,t,n){if(n){var i=e.href.replace(/(javascript:|#).*$/,"");e.replace(i+"#"+t)}else e.hash="#"+t}}),t.history=new B;m.extend=y.extend=U.extend=S.extend=B.extend=function(e,t){var i,r=this;return i=e&&n.has(e,"constructor")?e.constructor:function(){return r.apply(this,arguments)},n.extend(i,r,t),i.prototype=n.create(r.prototype,e),i.prototype.constructor=i,i.__super__=r.prototype,i};var z=function(){throw new Error('A "url" property or function must be specified')},F=function(e,t){var n=t.error;t.error=function(i){n&&n.call(t.context,e,i,t),e.trigger("error",e,i,t)}};return t})),
/*
 * R.js - Internationalisation Library
 *
 * R.js is a simple Javascript Internationalisation library
 *
 * This code is licensed under the MIT
 * For more details, see http://www.opensource.org/licenses/mit-license.php
 * For more information, see http://github.com/keithcirkel/R.js
 *
 * @author Keith Cirkel ('keithamus') <rdotjs@keithcirkel.co.uk>
 * @license http://www.opensource.org/licenses/mit-license.php
 * @copyright Copyright © 2011, Keith Cirkel
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 */
function(e){var t,n,i=e.R,r=!1,s={init:function(e){e=e||typeof navigator!==n?navigator.language:"en-GB",t.locales={},t.navLang=e,r=!0},slice:function(e){return Array.prototype.slice.call(e)},AinOf:function(e,t){for(var n=0,i=e.length;n<i;++n)if(e[n]===t)return n;return-1},realTypeOf:function(e){return Object.prototype.toString.call(e).match(/\w+/g)[1].toLowerCase()},render:function(e,n){return t.locales&&t.locales.hasOwnProperty(t.lang)&&t.locales[t.lang].hasOwnProperty(e)&&(e=t.locales[t.lang][e]),n&&0!==n.length?(n=s.parseVariables(n),s.format(e,n)):e},parseVariables:function(e,t){var n,i;switch(t||(t={i:[],s:[],named:{}}),s.realTypeOf(e)){case"number":t.i.push(e);break;case"string":t.s.push(e);break;case"date":t.i.push(e.toString());break;case"object":for(n in e)e.hasOwnProperty(n)&&("i"===n||"s"===n?s.parseVariables(e[n],t):t.named[n]=e[n]);break;case"array":for(n=0,i=e.length;n<i;++n)s.parseVariables(e[n],t)}return t},format:function(e,t){var i,r,s,o,a,u,l={i:"%i",s:"%s"};for(a in l){if(l.hasOwnProperty(a))for(s=(e.match(new RegExp(l[a],"g"))||[]).length,i=0;i<s;++i)(r=t[a].hasOwnProperty(i)?t[a][i]:r)!==n&&!1!==r&&(o=e.indexOf(l[a]))>=0&&(e=e.substr(0,o)+r+e.substr(o+2));r=!1}for(i in t.named)t.named.hasOwnProperty(i)&&(u=new RegExp("%\\("+i+"\\)","g"),e=e.replace(u,t.named[i]));return e}};t=function(e,t){if(r||s.init(),arguments.length>1){var n=s.slice(arguments);return n.shift(),s.render(e,n)}return s.render(e,[t])},t.registerLocale=function(e,n){return r||s.init(),t.locales[e]=n,t.setLocale(t.navlang),t},t.localeOrder=function(){return t.preferredLocales=s.slice(arguments),t.setLocale(t.lang)},t.setLocale=function(e,n){if(r||s.init(),n)return t.lang=e,t;var i,o=t.preferredLocales;if(!o)for(i in o=[],t.locales)t.locales.hasOwnProperty(i)&&o.push(i);return(i=s.AinOf(o,e))>0?(t.lang=o[i],t):(t.lang=o[0]||e,t)},t.noConflict=function(){return e.R=i,t},e.R=t}("undefined"!=typeof module&&module.exports?module.exports:this);var i18n={init:function(){R.registerLocale("en-US",{}),R.registerLocale("hu",{"Next unread":"Köv. olvasatlan",Edit:"Szerkesztés","All read":"Mindet olvasottá","Leave conversation":"Kilépés","{{ usercount }} participants":"{{ usercount }} résztvevő","Press Return to send, Shift-Return to break line.":"Nyomj Entert a mentéshez, Shift-Entert a sortöréshez.","Save message":"Üzenet mentése","Earlier messages":"Régebbi üzenetek","Add message":"Új üzenet","new messages":"új üzenet","Reply to {{ user.name }}'s message":"Válasz {{ user.name }} üzenetére",Cancel:"Mégse",Close:"Bezárás","You have no conversations.":"Nincs aktív beszélgetésed","Add conversation":"Új beszélgetés","Add conversation +":"Új beszélgetés +",Title:"Beszélgetés címe",Participants:"Résztvevők",Create:"Létrehozás","Sign out":"Kijelentkezés","Edit conversation":"Beszélgetés szerkesztése",Save:"Mentés","Searching...":"Keresés...","User not found.":"Nincs ilyen felhasználónk.","Enter username.":"Írj be egy felhasználónevet.","Do you want to leave conversation {{ title }}?\n\nIf you want to come back later, participants can invite you":"Biztosan kilépsz a következő beszélgetésből: {{ title }}?\n\nHa később vissza szeretnél lépni, a beszélgetés résztvevői újra meghívhatnak.","Get invite code":"Meghívó igénylés","Invite URL":"Meghívó URL","Edit profile":"Profil",Name:"Név",Avatar:"Avatár",Notifications:"Értesítések","Not supported":"Nem támogatott",Enabled:"Bekapcsolva",Disabled:"Kikapcsolva",Test:"Teszt",Disconnected:"Megszakadt a kapcsolat","You're disconnected":"Megszakadt a kapcsolat","Retrying in:":"Újracsatlakozás:",Reconnect:"Újracsatlakozás most","{{ participantName }} mentioned you in {{ waveName }}!":"{{ participantName }} emlegetette a neved itt: {{ waveName }}!"}),R.setLocale(navigator.language||navigator.browserLanguage),i18n.translateTemplates(),i18n.applyR($("body"))},applyR:function(e){$(".R",e).each((function(){var e=$(this);e.prop("placeholder")&&e.prop("placeholder",R(e.prop("placeholder"))),e.html(R(e.html())).removeClass("R")}))},translateTemplates:function(){var e,t,n,i,r=document.getElementsByTagName("script");for(e=0,t=r.length;e<t;e++)(n=r[e])&&n.innerHTML&&n.id&&("text/html"===n.type||"text/x-icanhaz"===n.type)&&(i=$(n.innerHTML),i18n.applyR(i),n.innerHTML=$("<div>").append(i).html())},__:function(e){return R(e)}};i18n.init();var __=i18n.__;function wordwrap(e,t,n,i){var r,s,o;if(n=arguments.length>=3?""+n:"\n",i=arguments.length>=4&&!!i,e+="",(t=arguments.length>=2?+t:75)<1)return e;var a,u=/\r\n|\n|\r/,l=/^\S*/,c=/\S*(\s)?$/,h=e.split(u),d=h.length;for(r=0;r<d;h[r++]+=o)for(o=h[r],h[r]="";o.length>t;){var f=o.slice(0,t+1),p=0,v=0;if((a=f.match(c))[1])s=t,p=1;else if((s=f.length-a[0].length)&&(v=1),!s&&i&&t&&(s=t),!s){var g=(o.slice(t).match(l)||[""])[0];s=f.length+g.length}h[r]+=o.slice(0,s-v),o=o.slice(s+p),h[r]+=o.length?n:""}return h.join("\n")}function nl2br(e,t){return null==e?"":(e+"").replace(/(\r\n|\n\r|\r|\n)/g,(t||void 0===t?"<br />":"<br>")+"$1")}function strip_tags(e,t){t=(((t||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return e.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,(function(e,n){return t.indexOf("<"+n.toLowerCase()+">")>-1?e:""}))}!function(e){var t={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:!1,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,theme:null,zindex:999,resultsLimit:null,enableHTML:!1,resultsFormatter:function(e){var t=e[this.propertyToSearch];return"<li>"+(this.enableHTML?t:y(t))+"</li>"},tokenFormatter:function(e){var t=e[this.propertyToSearch];return"<li><p>"+(this.enableHTML?t:y(t))+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",allowFreeTagging:!1,onResult:null,onCachedResult:null,onAdd:null,onFreeTaggingAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:!1},n={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"},i=0,r=1,s=2,o=8,a=9,u=13,l=27,c=37,h=38,d=39,f=40,p=108,v=188,g={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},m=/[&<>"'\/]/g;function y(e){return(t=e,String(null==t?"":t)).replace(m,(function(e){return g[e]}));var t}var w={init:function(n,i){var r=e.extend({},t,i||{});return this.each((function(){e(this).data("settings",r),e(this).data("tokenInputObject",new e.TokenList(this,n,r))}))},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(e){return this.data("tokenInputObject").add(e),this},remove:function(e){return this.data("tokenInputObject").remove(e),this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(e){return this.data("tokenInputObject").toggleDisabled(e),this},setOptions:function(t){return e(this).data("settings",e.extend({},e(this).data("settings"),t||{})),this}};e.fn.tokenInput=function(e){return w[e]?w[e].apply(this,Array.prototype.slice.call(arguments,1)):w.init.apply(this,arguments)},e.TokenList=function(t,g,m){if("string"===e.type(g)||"function"===e.type(g)){e(t).data("settings").url=g;var w=Z();void 0===e(t).data("settings").crossDomain&&"string"==typeof w&&(-1===w.indexOf("://")?e(t).data("settings").crossDomain=!1:e(t).data("settings").crossDomain=location.href.split(/\/+/g)[1]!==w.split(/\/+/g)[1])}else"object"==typeof g&&(e(t).data("settings").local_data=g);e(t).data("settings").classes?e(t).data("settings").classes=e.extend({},n,e(t).data("settings").classes):e(t).data("settings").theme?(e(t).data("settings").classes={},e.each(n,(function(n,i){e(t).data("settings").classes[n]=i+"-"+e(t).data("settings").theme}))):e(t).data("settings").classes=n;var b,k,_=[],x=0,T=new e.TokenList.Cache,C=e('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",e(t).data("settings").idPrefix+t.id).focus((function(){if(e(t).data("settings").disabled)return!1;null!==e(t).data("settings").tokenLimit&&e(t).data("settings").tokenLimit===x||e(t).data("settings").hintText&&($.html("<p>"+N(e(t).data("settings").hintText)+"</p>"),H()),I.addClass(e(t).data("settings").classes.focused)})).blur((function(){q(),e(this).val(""),I.removeClass(e(t).data("settings").classes.focused),e(t).data("settings").allowFreeTagging?j():e(this).val(""),I.removeClass(e(t).data("settings").classes.focused)})).bind("keyup keydown blur update",(function(){if(k===(k=C.val()))return;M.html(y(k)),C.width(M.width()+30)})).keydown((function(n){var s,g;switch(n.keyCode){case c:case d:case h:case f:if(e(this).val()){var m=null;(m=n.keyCode===f||n.keyCode===d?e(E).next():e(E).prev()).length&&X(m)}else s=O.prev(),g=O.next(),s.length&&s.get(0)===S||g.length&&g.get(0)===S?n.keyCode===c||n.keyCode===h?V(e(S),i):V(e(S),r):n.keyCode!==c&&n.keyCode!==h||!s.length?n.keyCode!==d&&n.keyCode!==f||!g.length||D(e(g.get(0))):D(e(s.get(0)));return!1;case o:if(s=O.prev(),!e(this).val().length)return S?(z(e(S)),A.change()):s.length&&D(e(s.get(0))),!1;1===e(this).val().length?q():setTimeout((function(){Q()}),5);break;case a:case u:case p:case v:return E?(W(e(E).data("tokeninput")),A.change()):(e(t).data("settings").allowFreeTagging?j():e(this).val(""),n.stopPropagation(),n.preventDefault()),!1;case l:return q(),!0;default:String.fromCharCode(n.which)&&setTimeout((function(){Q()}),5)}})),A=e(t).hide().val("").focus((function(){ee(C)})).blur((function(){C.blur()})),S=null,R=0,E=null,I=e("<ul />").addClass(e(t).data("settings").classes.tokenList).click((function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?function(t){var n=S;S&&V(e(S),s);n===t.get(0)?V(t,s):D(t)}(n):(S&&V(e(S),s),ee(C))})).mouseover((function(n){var i=e(n.target).closest("li");i&&S!==this&&i.addClass(e(t).data("settings").classes.highlightedToken)})).mouseout((function(n){var i=e(n.target).closest("li");i&&S!==this&&i.removeClass(e(t).data("settings").classes.highlightedToken)})).insertBefore(A),O=e("<li />").addClass(e(t).data("settings").classes.inputToken).appendTo(I).append(C),$=e("<div>").addClass(e(t).data("settings").classes.dropdown).appendTo("body").hide(),M=e("<tester/>").insertAfter(C).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:C.css("fontSize"),fontFamily:C.css("fontFamily"),fontWeight:C.css("fontWeight"),letterSpacing:C.css("letterSpacing"),whiteSpace:"nowrap"});A.val("");var U=e(t).data("settings").prePopulate||A.data("pre");function N(n){return e(t).data("settings").enableHTML?n:y(n)}function L(n){e(t).data("settings").disabled="boolean"==typeof n?n:!e(t).data("settings").disabled,C.attr("disabled",e(t).data("settings").disabled),I.toggleClass(e(t).data("settings").classes.disabled,e(t).data("settings").disabled),S&&V(e(S),s),A.attr("disabled",e(t).data("settings").disabled)}function P(){if(null!==e(t).data("settings").tokenLimit&&x>=e(t).data("settings").tokenLimit)return C.hide(),void q()}function j(){var n=e.trim(C.val()).split(e(t).data("settings").tokenDelimiter);e.each(n,(function(n,i){if(i){e.isFunction(e(t).data("settings").onFreeTaggingAdd)&&(i=e(t).data("settings").onFreeTaggingAdd.call(A,i));var r={};r[e(t).data("settings").tokenValue]=r[e(t).data("settings").propertyToSearch]=i,W(r)}}))}function B(n){var i=e(e(t).data("settings").tokenFormatter(n)),r=!0===n.readonly;r&&i.addClass(e(t).data("settings").classes.tokenReadOnly),i.addClass(e(t).data("settings").classes.token).insertBefore(O),r||e("<span>"+e(t).data("settings").deleteText+"</span>").addClass(e(t).data("settings").classes.tokenDelete).appendTo(i).click((function(){if(!e(t).data("settings").disabled)return z(e(this).parent()),A.change(),!1}));var s=n;return e.data(i.get(0),"tokeninput",n),_=_.slice(0,R).concat([s]).concat(_.slice(R)),R++,F(_,A),x+=1,null!==e(t).data("settings").tokenLimit&&x>=e(t).data("settings").tokenLimit&&(C.hide(),q()),i}function W(n){var i=e(t).data("settings").onAdd;if(x>0&&e(t).data("settings").preventDuplicates){var r=null;if(I.children().each((function(){var t=e(this),i=e.data(t.get(0),"tokeninput");if(i&&i.id===n.id)return r=t,!1})),r)return D(r),O.insertAfter(r),void ee(C)}(null==e(t).data("settings").tokenLimit||x<e(t).data("settings").tokenLimit)&&(B(n),P()),C.val(""),q(),e.isFunction(i)&&i.call(A,n)}function D(n){e(t).data("settings").disabled||(n.addClass(e(t).data("settings").classes.selectedToken),S=n.get(0),C.val(""),q())}function V(n,s){n.removeClass(e(t).data("settings").classes.selectedToken),S=null,s===i?(O.insertBefore(n),R--):s===r?(O.insertAfter(n),R++):(O.appendTo(I),R=x),ee(C)}function z(n){var i=e.data(n.get(0),"tokeninput"),r=e(t).data("settings").onDelete,s=n.prevAll().length;s>R&&s--,n.remove(),S=null,ee(C),_=_.slice(0,s).concat(_.slice(s+1)),s<R&&R--,F(_,A),x-=1,null!==e(t).data("settings").tokenLimit&&(C.show().val(""),ee(C)),e.isFunction(r)&&r.call(A,i)}function F(n,i){var r=e.map(n,(function(n){return"function"==typeof e(t).data("settings").tokenValue?e(t).data("settings").tokenValue.call(this,n):n[e(t).data("settings").tokenValue]}));i.val(r.join(e(t).data("settings").tokenDelimiter))}function q(){$.hide().empty(),E=null}function H(){$.css({position:"absolute",top:e(I).offset().top+e(I).outerHeight(),left:e(I).offset().left,width:e(I).width(),"z-index":e(t).data("settings").zindex}).show()}e(t).data("settings").processPrePopulate&&e.isFunction(e(t).data("settings").onResult)&&(U=e(t).data("settings").onResult.call(A,U)),U&&U.length&&e.each(U,(function(e,t){B(t),P()})),e(t).data("settings").disabled&&L(!0),e.isFunction(e(t).data("settings").onReady)&&e(t).data("settings").onReady.call(),this.clear=function(){I.children("li").each((function(){0===e(this).children("input").length&&z(e(this))}))},this.add=function(e){W(e)},this.remove=function(t){I.children("li").each((function(){if(0===e(this).children("input").length){var n=e(this).data("tokeninput"),i=!0;for(var r in t)if(t[r]!==n[r]){i=!1;break}i&&z(e(this))}}))},this.getTokens=function(){return _},this.toggleDisabled=function(e){L(e)};var J=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g");function K(e){return e.replace(J,"\\$&")}function G(e,t,n){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+K(t)+")(?![^<>]*>)(?![^&;]+;)","g"),function(e,t){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+K(t)+")(?![^<>]*>)(?![^&;]+;)","gi"),(function(e,t){return"<b>"+N(t)+"</b>"}))}(t,n))}function Y(n,i){if(i&&i.length){$.empty();var r=e("<ul>").appendTo($).mouseover((function(t){X(e(t.target).closest("li"))})).mousedown((function(t){return W(e(t.target).closest("li").data("tokeninput")),A.change(),!1})).hide();e(t).data("settings").resultsLimit&&i.length>e(t).data("settings").resultsLimit&&(i=i.slice(0,e(t).data("settings").resultsLimit)),e.each(i,(function(i,s){var o=e(t).data("settings").resultsFormatter(s);o=G(o,s[e(t).data("settings").propertyToSearch],n),o=e(o).appendTo(r),i%2?o.addClass(e(t).data("settings").classes.dropdownItem):o.addClass(e(t).data("settings").classes.dropdownItem2),0===i&&X(o),e.data(o.get(0),"tokeninput",s)})),H(),e(t).data("settings").animateDropdown?r.slideDown("fast"):r.show()}else e(t).data("settings").noResultsText&&($.html("<p>"+N(e(t).data("settings").noResultsText)+"</p>"),H())}function X(n){n&&(E&&function(n){n.removeClass(e(t).data("settings").classes.selectedDropdownItem),E=null}(e(E)),n.addClass(e(t).data("settings").classes.selectedDropdownItem),E=n.get(0))}function Q(){var n=C.val();n&&n.length&&(S&&V(e(S),r),n.length>=e(t).data("settings").minChars?(e(t).data("settings").searchingText&&($.html("<p>"+N(e(t).data("settings").searchingText)+"</p>"),H()),clearTimeout(b),b=setTimeout((function(){!function(n){var i=n+Z(),r=T.get(i);if(r)e.isFunction(e(t).data("settings").onCachedResult)&&(r=e(t).data("settings").onCachedResult.call(A,r)),Y(n,r);else if(e(t).data("settings").url){var s=Z(),o={data:{}};if(s.indexOf("?")>-1){var a=s.split("?");o.url=a[0];var u=a[1].split("&");e.each(u,(function(e,t){var n=t.split("=");o.data[n[0]]=n[1]}))}else o.url=s;o.data[e(t).data("settings").queryParam]=n,o.type=e(t).data("settings").method,o.dataType=e(t).data("settings").contentType,e(t).data("settings").crossDomain&&(o.dataType="jsonp"),o.success=function(r){T.add(i,e(t).data("settings").jsonContainer?r[e(t).data("settings").jsonContainer]:r),e.isFunction(e(t).data("settings").onResult)&&(r=e(t).data("settings").onResult.call(A,r)),C.val()===n&&Y(n,e(t).data("settings").jsonContainer?r[e(t).data("settings").jsonContainer]:r)},e.ajax(o)}else if(e(t).data("settings").local_data){var l=e.grep(e(t).data("settings").local_data,(function(i){return i[e(t).data("settings").propertyToSearch].toLowerCase().indexOf(n.toLowerCase())>-1}));T.add(i,l),e.isFunction(e(t).data("settings").onResult)&&(l=e(t).data("settings").onResult.call(A,l)),Y(n,l)}}(n)}),e(t).data("settings").searchDelay)):q())}function Z(){var n=e(t).data("settings").url;return"function"==typeof e(t).data("settings").url&&(n=e(t).data("settings").url.call(e(t).data("settings"))),n}function ee(e){setTimeout((function(){e.focus()}),50)}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),i={},r=0;this.add=function(e,t){r>n.max_size&&(i={},r=0),i[e]||(r+=1),i[e]=t},this.get=function(e){return i[e]}}}(jQuery);var Message,MessageCollection,randomName=function(){var e=["Aqua","Black","Blue","Fuchsia","Gray","Green","Lime","Maroon","Navy","Olive","Orange","Purple","Red","Silver","Teal","White","Yellow"],t=["Aardvark","Albatross","Alligator","Alpaca","Ant","Anteater","Antelope","Ape","Armadillo","Donkey","Baboon","Badger","Barracuda","Bat","Bear","Beaver","Bee","Bison","Boar","Buffalo","Butterfly","Camel","Capybara","Caribou","Cassowary","Cat","Caterpillar","Chamois","Cheetah","Chicken","Chimpanzee","Chinchilla","Chough","Clam","Cobra","Cockroach","Cod","Cormorant","Coyote","Crab","Crane","Crocodile","Crow","Curlew","Deer","Dinosaur","Dog","Dogfish","Dolphin","Dotterel","Dove","Dragonfly","Duck","Dugong","Dunlin","Eagle","Echidna","Eel","Eland","Elephant","Elk","Emu","Falcon","Ferret","Finch","Fish","Flamingo","Fly","Fox","Frog","Gaur","Gazelle","Gerbil","Giraffe","Gnat","Gnu","Goat","Goose","Goldfinch","Goldfish","Gorilla","Goshawk","Grasshopper","Grouse","Guanaco","Gull","Hamster","Hare","Hawk","Hedgehog","Heron","Herring","Hippopotamus","Hornet","Horse","Hummingbird","Hyena","Ibex","Ibis","Jackal","Jaguar","Jay","Jellyfish","Kangaroo","Kingfisher","Koala","Kookabura","Kouprey","Kudu","Lapwing","Lark","Lemur","Leopard","Lion","Llama","Lobster","Locust","Loris","Louse","Lyrebird","Magpie","Mallard","Manatee","Mandrill","Mantis","Marten","Meerkat","Mink","Mole","Mongoose","Monkey","Moose","Mouse","Mosquito","Mule","Narwhal","Newt","Nightingale","Octopus","Okapi","Opossum","Oryx","Ostrich","Otter","Owl","Ox","Oyster","Panther","Parrot","Partridge","Peafowl","Pelican","Penguin","Pheasant","Pig","Pigeon","Porcupine","Porpoise","Quail","Quelea","Quetzal","Rabbit","Raccoon","Rail","Ram","Rat","Raven","Reindeer","Rhinoceros","Rook","Salamander","Salmon","Sandpiper","Sardine","Scorpion","Seahorse","Seal","Shark","Sheep","Shrew","Skunk","Snail","Snake","Sparrow","Spider","Spoonbill","Squid","Squirrel","Starling","Stingray","Stinkbug","Stork","Swallow","Swan","Tapir","Tarsier","Termite","Tiger","Toad","Trout","Turkey","Turtle","Vicuna","Viper","Vulture","Wallaby","Walrus","Wasp","Weasel","Whale","Wolf","Wolverine","Wombat","Woodcock","Woodpecker","Worm","Wren","Yak","Zebra"];return function(){return e[Math.floor(Math.random()*e.length)]+t[Math.floor(Math.random()*t.length)]}}(),User=Backbone.Model.extend({defaults:{name:"",avatar:"",email:"",status:"offline",showPictures:!1,showVideos:!1},idAttribute:"_id",localAttributes:["showPictures","showVideos","showLinkPreviews"],update:function(e){_.each(e,(function(e,t){this.idAttribute!==t&&this.set(t,e)}),this)},chatInPrivateWaveWithUser:function(e){if(e!==this){var t=app.model.waves.filter((function(t){return 2===t.users.length&&t.users.contains(e)&&t.users.contains(this)}),this);t.length?app.navigate("wave/"+t[0].id,{trigger:!0}):Communicator.createWave(randomName()+"Room",[e.id])}},loadLocalAttributes:function(){void 0!==window.localStorage&&_.each(this.localAttributes,(function(e){var t=this.id+e;this.set(e,localStorage.getItem(t)>0)}),this)},saveLocalAttributes:function(){void 0!==window.localStorage&&_.each(this.localAttributes,(function(e){var t=this.id+e;localStorage.setItem(t,this.get(e)?1:0)}),this)}}),UserCollection=Backbone.Collection.extend({model:User,getUser:function(e){var t=this.get(e);return void 0===t&&(t=new User({_id:e,name:"[loading]"}),this.add(t),Communicator.getUser(e)),t}}),Wave=Backbone.Model.extend({defaults:{title:"",userIds:[],current:!1,archived:!0},idAttribute:"_id",initialize:function(){if(this.messages=new MessageCollection,this.users=new UserCollection,this.get("userIds")){var e=this.get("userIds");this.addUsers(e)}},addMessage:function(e){if(null!==e.get("parentId")){var t,n,i=this.messages.get(e.get("parentId"));if(!i)return this.messages.length>0&&(t=e.get("parentId"),n=this.messages.at(0).id,Communicator.getMessages(this,t,n)),!1;i.addReply(e),this.messages.add(e)}else this.messages.add(e);return Date.now()-e.get("created_at_date").getTime()<6048e5&&this.set("archived",!1),!0},addUser:function(e){this.users.add(e)},addUsers:function(e){_.each(e,(function(e){var t=app.model.users.get(e);this.addUser(t)}),this)},getUnreadCount:function(){return this.messages.reduce((function(e,t){return e+(t.get("unread")?1:0)}),0)},getUserNames:function(){return this.users.pluck("name").join(", ")},getUserCount:function(){return this.users.length},update:function(e){this.set("title",e.title);var t,n,i=this.get("userIds");e.userIds!==i&&(n=_.difference(e.userIds,i),t=_.difference(i,e.userIds),this.users.remove(t),this.addUsers(n),this.set("userIds",e.userIds))},setCurrentMessage:function(e){this.currentMessageId=e},getNextUnreadMessage:function(){var e,t,n,i,r=0;if(this.currentMessageId){if(i=this.messages.get(this.currentMessageId),r=i.getSortableId(),e=i.getNextUnread(r,!1,[]))return e;r=i.getRootId()}for(t=this.messages.filter((function(e){return e.getSortableId()>r&&null===e.get("parentId")})),n=0;n<t.length;n++)if(e=t[n].getNextUnread(r,!0,[]))return e;if(r>0)for(t=this.messages.filter((function(e){return e.getSortableId()<r&&null===e.get("parentId")})),n=0;n<t.length;n++)if(e=t[n].getNextUnread(0,!0,[]))return e;return e||this.trigger("noMoreUnread"),e},getPreviousMessages:function(){if(this.messages.length){var e=this.messages.at(0).id;Communicator.getMessages(this,null,e)}},readAllMessages:function(){var e=!1;this.messages.each((function(t){e=t.readAllMessages()||e})),e&&(this.trigger("readAll"),Communicator.readAllMessages(this))},quit:function(){Communicator.quitUser(this.id),app.currentWaveId=null,app.model.waves.remove(this),app.model.messages.remove(app.model.messages.where({waveId:this.id}),{silent:!0}),app.showLastWave()}}),WaveCollection=Backbone.Collection.extend({model:Wave,comparator:function(e){return e.id}});Message=Backbone.Model.extend({defaults:{userId:null,waveId:null,parentId:null,message:"",unread:!0,created_at:null,created_at_date:null},idAttribute:"_id",initialize:function(){this.messages=null,this.linkPreviews=[],this.user=app.model.users.getUser(this.get("userId")),this.formatMessage(),this.set("created_at_date",new Date(this.get("created_at"))),this.isNew()||this.set("unread",this.get("unread")&&app.model.currentUser.id!==this.get("userId"))},addReply:function(e){null===this.messages&&(this.messages=new MessageCollection,this.trigger("messagesCreated")),this.messages.add(e)},read:function(){this.get("unread")&&(this.set("unread",!1),Communicator.readMessage(this))},setCurrent:function(){this.getWave().setCurrentMessage(this.id)},setScrolled:function(){this.trigger("change:scrolled")},formatMessage:function(){var e,t,n,i,r,s,o=this.get("message"),a=/((https?:\/\/|www\.)\S+)/g,u=/\.(jpg|png|gif)(\?.*)?$/gi,l=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]+).*/gim,c=/.*youtu.*/im,h="";for(t=0,n=(e=(o=strip_tags(o=(o=(o=o.replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/\n/g," \n"))).split(" ")).length;t<n;t++)(i=e[t].match(a))?(r=s=i[0],s=s.length>53?s.substr(0,50)+"...":s,r="http"===r.substr(0,4)?r:"http://"+r,app.model.currentUser.get("showPictures")&&r.match(u)?h='<br><a href="'+r+'" target="_blank"><img class="message-img" src="'+r+'"></a>':app.model.currentUser.get("showVideos")&&r.match(l)&&r.match(c)?h='<br><iframe width="420" height="315" src="https://youtube.com/embed/'+(r=l.exec(r))[2]+'" frameborder="0" allowfullscreen></iframe>':(h='<a href="'+r+'" target="_blank">'+s+"</a>",app.model.currentUser.get("showLinkPreviews")&&Communicator.getLinkPreview(r,this)),e[t]=e[t].replace(i[0],h)):e[t]=wordwrap(e[t],200," ",!0);o=nl2br(o=e.join(" "),!0),this.set("messageFormatted",o)},getSortableId:function(){if(!this.sortableId)if(24===this.id.toString().length){var e=Number("0x"+this.id.substr(0,8)),t=Number("0x"+this.id.substr(18,6));this.sortableId=e+t%1e3/1e3}else this.sortableId=this.id;return this.sortableId},readAllMessages:function(){var e=this.get("unread");return this.set({unread:!1},{silent:!0}),e},getNextUnread:function(e,t,n){if(_.indexOf(n,this.getSortableId())>-1)return null;if(n.push(this.getSortableId()),this.getSortableId()>e&&this.get("unread"))return this;var i,r=this.messages?this.messages.toArray():[],s=null;for(i=0;i<r.length;i++)if(s=r[i].getNextUnread(e,!0,n))return s;return s||!this.get("parentId")||t?s:app.model.messages.get(this.get("parentId")).getNextUnread(0,!1,n)},getRootId:function(){return this.get("parentId")?app.model.messages.get(this.get("parentId")).getRootId():this.getSortableId()},getWave:function(){return app.model.waves.get(this.get("waveId"))},isCurrentUserMentioned:function(){if(this.get("unread")){var e="@"+app.model.currentUser.get("name");return this.get("message").indexOf(e)>=0}return!1},addLinkPreview:function(e){this.linkPreviews.push(e),this.trigger("linkpreview",e)}}),MessageCollection=Backbone.Collection.extend({model:Message,comparator:function(e){return e.getSortableId()}});var SurfAppModel=Backbone.Model.extend({initialize:function(){this.waves=new WaveCollection,this.users=new UserCollection,this.messages=new MessageCollection,this.currentUser=null,this.ready=!1},initCurrentUser:function(e){this.currentUser=e,this.currentUser.loadLocalAttributes(),this.trigger("initCurrentUser")},setReady:function(){this.ready=!0,this.trigger("ready")}}),UserView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render","update","chatInPrivate"),this.listenTo(this.model,"change",this.update)},events:{dblclick:"chatInPrivate"},render:function(){var e=_.template($("#user_view").text());return this.setElement(e(this.model.toJSON())),this.$el.attr("src",this.model.get("avatar")),this},update:function(){return this.$el.removeClass("online offline").addClass(this.model.get("status")),this.$el.attr("title",this.model.get("name")),this.$el.attr("alt",this.model.get("name")),this.$el.attr("src")!==this.model.get("avatar")&&this.$el.attr("src",this.model.get("avatar")),this},chatInPrivate:function(){app.model.currentUser.chatInPrivateWaveWithUser(this.model)}}),WaveListView=Backbone.View.extend({initialize:function(){_.bindAll(this,"setCurrent","countMessages","updateMessages","changeUsers","updateTitle","scrollToNextUnread","removeWave"),this.listenTo(this.model,"change:current",this.setCurrent),this.listenTo(this.model,"change:title",this.updateTitle),this.listenTo(this.model,"remove",this.removeWave),this.listenTo(this.model.messages,"change:unread",this.countMessages),this.listenTo(this.model,"readAll",this.countMessages),this.listenTo(this.model.messages,"add",this.countMessages),this.listenTo(this.model.messages,"add",this.updateMessages),this.listenTo(this.model.users,"add",this.changeUsers),this.listenTo(this.model.users,"remove",this.changeUsers)},events:{click:"scrollToNextUnread"},render:function(){var e=_.extend(this.model.toJSON(),{id:this.model.id}),t=_.template($("#wave_list_view").text());return this.setElement(t(e)),this.changeUsers(),this.countMessages(),this.setCurrent(),this},setCurrent:function(){this.model.get("current")&&($(".waveitem").removeClass("open"),this.$el.addClass("open"))},countMessages:function(){var e=this.model.getUnreadCount();e>0?(this.$el.find(".piros").text("| "+e+" "+__("new messages")),this.$el.addClass("updated")):(this.$el.find(".piros").text(""),this.$el.removeClass("updated"))},updateMessages:function(e){e.get("userId")!==app.model.currentUser.id&&e.get("unread")&&this.$el.addClass("updated")},changeUsers:function(){var e=__("{{ usercount }} participants").replace("{{ usercount }}",this.model.getUserCount());this.$el.find(".usercount").text(e)},updateTitle:function(){this.$el.find("h2").text(this.model.get("title"))},scrollToNextUnread:function(e){if(app.currentWaveId===this.model.id){e.preventDefault();var t=this.model.getNextUnreadMessage();t&&t.setScrolled()}$("body.mobile #wave-list").css("left","-55%")},removeWave:function(e){e.id===this.model.id&&this.$el.remove()}}),WaveView=Backbone.View.extend({initialize:function(){_.bindAll(this,"setCurrent","addMessage","addUser","removeUser","updateTitle","showUpdateWave","scrollToNextUnread","scrollToBottom","readAllMessages","quitWave","removeWave","countOfflineUsers","readAll"),this.userViews=[],this.listenTo(this.model,"change:current",this.setCurrent),this.listenTo(this.model,"change:title",this.updateTitle),this.listenTo(this.model,"noMoreUnread",this.scrollToBottom),this.listenTo(this.model,"remove",this.removeWave),this.listenTo(this.model,"readAll",this.readAll),this.listenTo(this.model,"scrollToNextUnread",this.scrollToNextUnread),this.listenTo(this.model.messages,"add",this.addMessage),this.listenTo(this.model.users,"add",this.addUser),this.listenTo(this.model.users,"remove",this.removeUser),this.listenTo(this.model.users,"change",this.countOfflineUsers)},events:{"click a.editwave":"showUpdateWave","click a.gounread":"scrollToNextUnread","click div.wavetop":"scrollToNextUnread","click a.getprevmessages":"getPreviousMessages","click a.readall":"readAllMessages","click a.quit":"quitWave"},render:function(){var e=_.extend(this.model.toJSON(),{id:this.model.id}),t=new WaveReplyFormView({model:this.model});return this.setElement(waveTemplate(e)),this.$el.hide(),t.render().$el.appendTo(this.$el.find(".waves-container")),this.model.users.each(this.addUser),this.fragmentMode=!0,this.fragment=$(document.createDocumentFragment()),this.model.messages.each(this.addMessage,this),this.fragmentMode=!1,this.$el.find(".messages").append(this.fragment),this},setCurrent:function(){this.model.get("current")&&($(".wave").hide(),this.$el.show(),this.scrollToNextUnread())},addMessage:function(e){if(null===e.get("parentId")){var t,n=new MessageView({model:e}).render().el;this.fragmentMode?this.fragment.append(n):0===(t=this.model.messages.where({parentId:null}).indexOf(e))?this.$el.find("div.getprevmessages").after(n):this.$el.find(".messages > .message").eq(t-1).after(n)}},changeUsers:function(){var e=this.model.getUserNames();this.$el.find("span.usernames").text(e)},addUser:function(e){this.changeUsers();var t=new UserView({model:e});this.userViews[e.id]=t,this.$el.find(".heads").append(t.render().el),this.countOfflineUsers()},removeUser:function(e){this.changeUsers(),this.userViews[e.id].remove(),delete this.userViews[e.id],this.countOfflineUsers()},countOfflineUsers:function(){var e=this.$el.find(".offline-list"),t=this.model.users.where({status:"offline"}).length;t>0?(e.find(".count").text(t),e.show()):e.hide()},updateTitle:function(){this.$el.find("h2").text(this.model.get("title"))},showUpdateWave:function(){return app.view.showUpdateWave()},scrollToNextUnread:function(e){ga("send","event","WaveView","scrollToNextUnread"),e&&e.preventDefault();var t=this.model.getNextUnreadMessage();return t&&t.setScrolled(),!1},scrollToBottom:function(){var e=this.$el.find(".waves-container");e.scrollTop(e.prop("scrollHeight")).focus()},getPreviousMessages:function(e){e.preventDefault(),ga("send","event","WaveView","getPreviousMessages"),this.model.getPreviousMessages()},readAllMessages:function(e){ga("send","event","WaveView","readAllMessages"),e.preventDefault(),this.model.readAllMessages()},quitWave:function(e){ga("send","event","WaveView","quitWave"),e.preventDefault();var t=__("Do you want to leave conversation {{ title }}?\n\nIf you want to come back later, participants can invite you").replace("{{ title }}",this.model.get("title"));confirm(t)&&this.model.quit()},removeWave:function(e){e.id===this.model.id&&this.$el.remove()},readAll:function(){this.$el.find("table.unread").removeClass("unread")}}),MessageView=Backbone.View.extend({initialize:function(){this.model.messages?this.listenTo(this.model.messages,"add",this.addMessage):this.listenTo(this.model,"messagesCreated",(function(){this.listenTo(this.model.messages,"add",this.addMessage),this.stopListening(this.model,"messagesCreated")})),this.listenTo(this.model,"change:unread",this.onReadMessage),this.listenTo(this.model,"change:scrolled",this.scrollTo),this.listenTo(this.model.user,"change:name",this.changeUserName),this.listenTo(this.model,"linkpreview",this.addLinkPreview);var e=this.model.get("created_at_date");this.model.set("dateFormatted",this.formatDate(e))},inRender:!1,events:{click:"readMessage",dbltap:"replyMessage","click a.reply":"replyMessage","click a.threadend":"replyMessage"},render:function(){var e=_.extend(this.model.toJSON(),{id:this.model.id,user:this.model.user.toJSON()}),t=new UserView({model:this.model.user}),n=this;return this.setElement(messageTemplate(e)),this.model.get("unread")||this.$el.children("table").removeClass("unread"),this.$el.find(".message-header").html(t.render().el),this.$el.children("div.threadend").hide(),this.model.isCurrentUserMentioned()&&this.mention(),this.model.messages&&(this.inRender=!0,this.model.messages.each(this.addMessage,this),this.inRender=!1),this.model.linkPreviews.forEach((function(e){n.addLinkPreview(e)})),this},addMessage:function(e){var t=new MessageView({model:e});this.$el.children(".replies").append(t.render().el),(this.inRender||1===this.model.messages.length)&&0===this.$el.children("div.replyform").length&&this.$el.children("div.threadend").show()},readMessage:function(e){e.stopPropagation(),this.model.read(),this.model.setCurrent()},onReadMessage:function(){this.model.get("unread")||this.$el.children("table").removeClass("unread")},scrollTo:function(){var e=this.$el.position().top,t=this.$el.parents(".waves-container"),n=t.height();this.$el.triggerHandler("click"),(e<0||e>n)&&t.scrollTop(e+t.scrollTop()-.3*n),this.$el.children("table").focus()},replyMessage:function(e){if("TEXTAREA"!==e.target.nodeName){e.preventDefault();var t,n=this.$el.find("> div:last-child").hasClass("replyform");return this.model.getWave().trigger("hideReplyForm"),n?!1:((t=new MessageReplyFormView({model:this.model})).render(),t.show(this.$el),!1)}},changeUserName:function(){this.$el.find("span.author").eq(0).text(this.model.user.get("name")+":")},mention:function(){if("undefined"!=typeof Notification){var e,t,n=!1,i=this;if("granted"===Notification.permission?n=!0:"denied"!==Notification.permission&&Notification.requestPermission((function(e){"granted"===e&&(n=!0)})),n){t=__("{{ participantName }} mentioned you in {{ waveName }}!").replace("{{ participantName }}",this.model.user.get("name")).replace("{{ waveName }}",this.model.getWave().get("title"));try{(e=new Notification(t,{tag:"mentionNotification",icon:"/images/surf-ico.png"})).onclick=function(){i.model.setScrolled()},e.onshow=function(){setTimeout(e.close.bind(e),5e3)}}catch(e){}}}},addLinkPreview:function(e){var t=$(linkPreviewTemplate(_.extend({title:null,image:null,description:null},e)));e.image||t.find("img").remove(),this.$el.children("table").append(t)},formatDate(e){const t=new Date(e);return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}}),WaveReplyFormView=Backbone.View.extend({initialize:function(){_.bindAll(this,"submitForm","handleKeydown")},events:{"submit form":"submitForm","keydown textarea":"handleKeydown"},render:function(){var e=_.template($("#wavereplyform_view").text());return this.setElement(e()),this},submitForm:function(e){e.preventDefault();var t=this.$el.find("textarea");return t.val().length>0&&Communicator.sendMessage(t.val(),this.getWaveId(),this.getParentId()),t.val(""),!1},handleKeydown:function(e){e.shiftKey||13!==e.keyCode?32===e.keyCode&&" "===$(e.target).val()?(e.preventDefault(),this.scrollToNextUnread()):e.shiftKey||9!==e.keyCode||(e.preventDefault(),this.mentionUser()):(e.preventDefault(),this.$el.find("form").submit()),e.stopPropagation()},scrollToNextUnread:function(){this.model.trigger("scrollToNextUnread")},getWaveId:function(){return this.model.id},getWave:function(){return app.model.waves.get(this.getWaveId())},getParentId:function(){return null},mentionUser:function(){var e,t,n,i,r=0,s=this.$el.find("textarea"),o=s[0].selectionEnd||0,a=s.val().lastIndexOf("@",o);if(a>-1&&o-a<50&&(e=s.val().substring(a+1,o).toLowerCase(),(t=this.getWave().users.filter((function(t){return 0===t.get("name").toLowerCase().indexOf(e)}))).length>0)){if(1===t.length)n=t[0].get("name");else{for(n=t[0].get("name").substr(0,e.length),i=function(e){return e.get("name").substr(0,n.length)===n};_.all(t,i);)n=t[0].get("name").substr(0,n.length+1);n=n.substr(0,n.length-1)+"?",r=1}s.val(s.val().substring(0,a+1)+n+s.val().substr(o)),s[0].selectionStart=a+1+n.length-r,s[0].selectionEnd=a+1+n.length}}}),MessageReplyFormView=WaveReplyFormView.extend({events:_.extend({"click a.cancel":"handleCancel"},WaveReplyFormView.prototype.events),initialize:function(){WaveReplyFormView.prototype.initialize.apply(this,arguments),this.timeout=75,_.bindAll(this,"handleCancel","hide"),this.listenTo(this.model.getWave(),"hideReplyForm",this.hide)},render:function(){var e=_.template($("#messagereplyform_view").text());return this.setElement(e({user:this.model.user.toJSON()})),this},handleCancel:function(e){return e.preventDefault(),this.hide(),!1},scrollToNextUnread:function(){this.model.getWave().trigger("scrollToNextUnread")},getWaveId:function(){return this.model.get("waveId")},getParentId:function(){return this.model.id},show:function(e){var t=e.children("div.threadend");t.is(":visible")?(t.hide(),this.$el.height(t.height()).appendTo(e).animate({height:"100%"},this.timeout,(function(){$(this).find("textarea").focus()}))):this.$el.hide().appendTo(e).slideDown(this.timeout,(function(){$(this).find("textarea").focus()}))},hide:function(){var e,t=this;this.$el.siblings(".replies").children().length>0?(e=this.$el.siblings(".threadend"),this.$el.animate({height:e.height()},this.timeout,(function(){e.show(),t.remove()}))):this.$el.slideUp(this.timeout,(function(){t.remove()}))}}),EditWaveView=Backbone.View.extend({initialize:function(){_.bindAll(this,"show","hide","setWave","genUserArray","inviteCodeReady"),this.userArray=[],this.listenTo(this.model.users,"add",this.genUserArray),this.listenTo(this.model.users,"change",this.genUserArray)},events:{"click a.close":"hide","submit form":"editWave","click button#editwave-invite":"getInviteCode"},render:function(){var e=_.template($("#editwave_view").text());return this.setElement(e()),this.$el.hide(),this},genUserArray:function(){this.userArray=this.model.users.reduce((function(e,t){var n={id:t.id,name:t.get("name")+" ("+t.get("email")+")"};return(!this.wave||this.wave&&!this.wave.users.get(t.id))&&e.push(n),e}),[],this)},initUserSuggest:function(){this.genUserArray(),this.inited||(this.$el.find("#editwave-users").tokenInput([],{theme:"facebook",preventDuplicates:!0,hintText:__("Enter username."),noResultsText:__("User not found."),searchingText:__("Searching...")}),this.inited=!0)},updateUserSuggest:function(){this.initUserSuggest(),$("#editwave-users").data("settings").local_data=this.userArray;var e=this.$el.find("#editwave-users");e.tokenInput("clear"),this.wave?this.wave.users.each((function(t){e.tokenInput("add",{id:t.id,name:t.get("name"),readonly:!0})})):e.tokenInput("add",{id:app.model.currentUser.id,name:app.model.currentUser.get("name"),readonly:!0})},show:function(){return ga("send","event","EditWaveView","show"),this.$el.find("#editwave-invitecode-block").hide(),this.wave?(this.$el.find("input[name=title]").val(this.wave.get("title")),this.$el.find("h2").text(__("Edit conversation")),this.$el.find("#editwave-submit").text(__("Save")),this.$el.find("#editwave-invite").show()):(this.$el.find("input[name=title]").val(""),this.$el.find("h2").text(__("Add conversation")),this.$el.find("#editwave-submit").text(__("Create")),this.$el.find("#editwave-invite").hide()),this.updateUserSuggest(),this.$el.show(),$("#darken").show(),this.$el.find("#editwave-title").focus(),!1},hide:function(){return this.$el.hide(),$("#darken").hide(),!1},setWave:function(e){this.wave=this.model.waves.get(e),this.wave&&this.listenTo(this.wave,"inviteCodeReady",this.inviteCodeReady)},editWave:function(){var e=this.$el.find("#editwave-title").val(),t=this.$el.find("#editwave-users").tokenInput("get"),n=_.pluck(t,"id");return this.wave?Communicator.updateWave(this.wave.id,e,n):Communicator.createWave(e,n),this.hide()},getInviteCode:function(e){ga("send","event","EditWaveView","getInviteCode"),e.preventDefault(),this.$el.find("button#editwave-invite").hide(),Communicator.getInviteCode(this.wave.id)},inviteCodeReady:function(e){this.$el.find("#editwave-invitecode-block").show();var t=document.location.protocol+"//"+document.location.host+"/invite/"+e;this.$el.find("#editwave-invitecode").val(t).focus().select()}}),EditUserView=Backbone.View.extend({initialize:function(){_.bindAll(this,"show","hide","testNotification"),this.listenTo(this.model,"change",this.updateFields)},events:{"click a.close":"hide","submit form":"saveUser","click button#edituser-notification-test":"testNotification"},render:function(){var e=_.template($("#edituser_view").text());return this.setElement(e()),this.$el.hide(),this.updateFields(),this},updateFields:function(){this.$el.find("#edituser-name").val(this.model.get("name")),this.$el.find("#edituser-avatar").val(this.model.get("avatar")),this.$el.find("input#edituser-show-pictures").attr("checked",this.model.get("showPictures")),this.$el.find("input#edituser-show-videos").attr("checked",this.model.get("showVideos")),this.$el.find("input#edituser-show-linkpreviews").attr("checked",this.model.get("showLinkPreviews")),this.$el.find("div.avatar").remove();var e="https://secure.gravatar.com/avatar/"+this.model.get("emailMD5")+"?s=80&d=monsterid";this.model.get("googleAvatar")&&this.addAvatarOption(this.model.get("googleAvatar")),this.model.get("facebookAvatar")&&this.addAvatarOption(this.model.get("facebookAvatar")),this.addAvatarOption(e)},addAvatarOption:function(e){var t=$(_.template($("#edituser_avatar_view").text())({url:e}));t.find("img").prop("src",e),e===this.model.get("avatar")&&t.find("input").prop("checked",!0),this.$el.find(".ediutuser-avatar-row .right").append(t)},show:function(){return this.$el.show(),$("#darken").show(),this.checkNotification(),!1},hide:function(){return this.$el.hide(),$("#darken").hide(),!1},saveUser:function(e){e.preventDefault();var t=this.$el.find("#edituser-name").val(),n=this.$el.find("input[name=edituser-avatar-cb]:checked").val();return this.model.set("showPictures",this.$el.find("input#edituser-show-pictures").is(":checked"),{silent:!0}),this.model.set("showVideos",this.$el.find("input#edituser-show-videos").is(":checked"),{silent:!0}),this.model.set("showLinkPreviews",this.$el.find("input#edituser-show-linkpreviews").is(":checked"),{silent:!0}),this.model.saveLocalAttributes(),Communicator.updateUser(t,n),this.hide()},checkNotification:function(){window.Notification||(this.$el.find("#edituser-notification-status").text(__("Not supported")),this.$el.find("#edituser-notification-test").hide()),"granted"===Notification.permission?this.$el.find("#edituser-notification-status").text(__("Enabled")):this.$el.find("#edituser-notification-status").text(__("Disabled"))},testNotification:function(){var e=this;Notification.requestPermission((function(t){if("granted"===t){var n=new Notification("Test notification",{tag:"mentionNotification",icon:"/images/surf-ico.png"});n.onshow=function(){setTimeout(n.close.bind(n),5e3)},e.checkNotification()}}))}}),DisconnectedView=Backbone.View.extend({initialize:function(){_.bindAll(this,"show"),this.counterStart=3,this.counter=this.counterStart},render:function(){var e=_.template($("#disconnected_view").text());return this.setElement(e({counter:this.counter})),this.$el.hide(),this},show:function(){if(ga("send","event","DisconnectedView","show","connection",this.model.reconnect?1:0),this.model.reconnect){var e=this;this.interval=setInterval((function(){e.count()}),1e3)}else this.$el.find(".countdown").hide();return this.$el.show(),$("#darken").show(),!1},count:function(){if(this.counter--,this.counter>0)this.$el.find(".counter").text(this.counter);else{var e=this;clearInterval(e.interval),$.ajax("images/surf-ico.png?"+Math.random(),{timeout:900}).fail((function(){e.counterStart*=2,e.counter=e.counterStart,e.interval=setInterval((function(){e.count()}),1e3)})).done((function(){document.location.href="/"}))}}}),SurfAppView=Backbone.View.extend({initialize:function(){_.bindAll(this,"addMessage","showCreateWave","showUpdateWave","showEditUser","hideOverlays","addWave"),this.listenTo(this.model.waves,"add",this.addWave),this.listenTo(this.model.waves,"reset",this.resetWaves),this.listenTo(this.model.waves,"reset",this.handleEmpty),this.listenTo(this.model.waves,"remove",this.handleEmpty),this.listenTo(this.model.messages,"reset",this.resetMessages),this.listenTo(this.model.messages,"add",this.setTitle),this.listenTo(this.model.messages,"change:unread",this.setTitle),this.listenTo(this.model.waves,"readAll",this.setTitle),this.listenTo(this.model.waves,"change:current",this.renderWave),this.listenTo(this.model,"initCurrentUser",this.initCurrentUser),this.listenTo(this.model,"ready",this.handleReady),this.renderedWaves=[],this.waveListViews=[],this.render()},events:{"click a.addwave":"showCreateWave","click a.edituser":"showEditUser","click #darken":"hideOverlays"},render:function(){this.setElement($("body")),this.editWaveView=new EditWaveView({model:this.model}),this.$el.append(this.editWaveView.render().el),this.iconImage=new Image;var e=this;return this.iconImage.onload=function(){e.setTitle()},this.iconImage.src="images/surf-ico.png",$(".empty").hide(),$("body").keydown((function(e){var t=$(e.target).prop("nodeName");"INPUT"!==t&&"TEXTAREA"!==t&&32===e.keyCode&&(e.preventDefault(),app.currentWaveId&&(document.activeElement.blur(),app.model.waves.get(app.currentWaveId).trigger("scrollToNextUnread")))})),$(window).resize((function(){$(window).width()<1e3?($("body").addClass("mobile"),$("body.mobile").on("swiperight",(function(){$("body.mobile #wave-list").css("left",0)})),$("body.mobile").on("swipeleft",(function(){$("body.mobile #wave-list").css("left","-55%")})),$("body.mobile #header-logo").on("click",(function(){return 0===parseInt($("#wave-list").css("left"))?$("body.mobile #wave-list").css("left","-55%"):$("body.mobile #wave-list").css("left",0),!1}))):$("body").removeClass("mobile")})).trigger("resize"),this},addWave:function(e){var t=new WaveListView({model:e});this.handleEmpty(),(e.get("archived")?$("#wave-list-archived"):$("#wave-list-active")).append(t.render().el),this.waveListViews.push(t)},resetWaves:function(){this.model.waves.map(this.addWave,this)},renderWave:function(e){if(!_.contains(this.renderedWaves,e)){var t=new WaveView({model:e});$("#wave-container").append(t.render().el),t.setCurrent(),this.renderedWaves.push(e)}},addMessage:function(e){var t=this.model.waves.get(e.get("waveId"));t&&t.addMessage(e)},resetMessages:function(){this.model.messages.map(this.addMessage),this.setTitle()},showCreateWave:function(){return this.editWaveView.setWave(null),this.editWaveView.show(),!1},showUpdateWave:function(){return this.editWaveView.setWave(app.model.waves.get(app.currentWaveId)),this.editWaveView.show(),!1},showEditUser:function(){return this.editUserView&&this.editUserView.show(),!1},showDisconnected:function(e){this.disconnectedView=new DisconnectedView({model:{reconnect:e}}),this.$el.append(this.disconnectedView.render().el),this.disconnectedView.show()},hideOverlays:function(){return _.isUndefined(this.disconnectedView)&&($("#darken").hide(),$(".overlay").hide()),!1},initCurrentUser:function(){var e=new UserView({model:this.model.currentUser});return this.$el.find("#currentuser").html("").append(e.render().el).append(' <p class="currentuser_name">'+this.model.currentUser.escape("name")+"</p>"),this.listenTo(this.model.currentUser,"change:name",this.changeCurrentUserName),this.editUserView=new EditUserView({model:this.model.currentUser}),this.$el.append(this.editUserView.render().el),!1},changeCurrentUserName:function(){return this.$el.find("p.currentuser_name").text(this.model.currentUser.escape("name")),!1},setTitle:function(){if(this.model.ready){var e="SURF",t=this.model.messages.where({unread:!0}).length;t>0&&(e="["+t+"] "+e),$("title").text(e),this.setIcon(t)}},setIcon:function(e){if(this.iconImage.complete)try{var t,n,i,r=document.createElement("canvas");r.width=35,r.height=35,(t=r.getContext("2d")).drawImage(this.iconImage,0,0),e>0&&(n=e>99?"99+":e.toString(),t.fillStyle="#ffffff",t.globalAlpha=.7,t.fillRect(34-9*n.length,21,9*n.length+1,14),t.globalAlpha=1,t.fillStyle="#847099",t.font="bold 16px sans-serif",t.fillText(n,35-9*n.length,35)),(i=document.createElement("link")).type="image/x-icon",i.rel="shortcut icon",i.href=r.toDataURL("image/x-icon"),$('link[rel="shortcut icon"]').remove(),$("head").append(i)}catch(e){return e}},handleEmpty:function(){0===app.model.waves.length?$(".empty").show():$(".empty").hide()},handleReady:function(){this.handleArchiveChange(),this.setTitle(),this.listenTo(this.model.waves,"change:archived",this.handleArchiveChange),this.listenTo(this.model.waves,"add",this.handleArchiveChange)},handleArchiveChange:function(){this.waveListViews.forEach((function(e){e.remove()})),this.waveListViews=[],this.model.waves.forEach(this.addWave,this),0===this.model.waves.filter({archived:!1}).length?$("#wave-list-active").hide():$("#wave-list-active").show(),0===this.model.waves.filter({archived:!0}).length?$("#wave-list-archived").hide():$("#wave-list-archived").show()}}),Communicator={socket:null,reconnect:!0,createTitle:null,readQueue:[],queueReads:!1,initialize:function(){if(void 0!==window.io){var e=this;this.socket=io({reconnection:!1}),this.socket.on("init",(function(t){e.onInit(t)})),this.socket.on("message",(function(t){e.onMessage(t)})),this.socket.on("disconnect",(function(){app.view.showDisconnected(e.reconnect)})),this.socket.on("updateUser",this.onUpdateUser),this.socket.on("updateWave",(function(t){e.onUpdateWave(t)})),this.socket.on("inviteCodeReady",this.onInviteCodeReady),this.socket.on("linkPreviewReady",this.onLinkPreviewReady),this.socket.on("dontReconnect",(function(){e.reconnect=!1})),this.socket.on("ready",(function(){e.queueReads=app.model.messages.where({unread:!0}).length>1,app.showLastWave(),app.model.setReady()}))}else console.error("no io")},onInit:function(e){null===app.model.currentUser&&(e.users.push(e.me),app.model.users.reset(e.users),app.model.initCurrentUser(app.model.users.get(e.me._id)),app.model.waves.reset(e.waves))},sendMessage:function(e,t,n){var i={userId:app.model.currentUser.id,waveId:t,message:e,parentId:n};this.socket.emit("message",i)},readMessage:function(e){this.queueReads?(this.readQueue.push(e),this.queueReads=!1):(this.readQueue.forEach((function(e){this.socket.emit("readMessage",{id:e.id,waveId:e.get("waveId")})}),this),this.readQueue=[],this.socket.emit("readMessage",{id:e.id,waveId:e.get("waveId")}))},readAllMessages:function(e){this.socket.emit("readAllMessages",{waveId:e.id})},createWave:function(e,t){var n={title:e,userIds:t};this.createTitle=e,this.socket.emit("createWave",n)},updateWave:function(e,t,n){var i={id:e,title:t,userIds:n};this.socket.emit("updateWave",i)},onMessage:function(e){if(e.messages)_.each(e.messages,(function(e){this.onMessage(e)}),this);else{var t=new Message(e);app.model.waves.get(e.waveId).addMessage(t)&&app.model.messages.add(t)}},onUpdateUser:function(e){var t=e.user;app.model.users.get(t._id)?app.model.users.get(t._id).update(t):app.model.users.add(new User(t))},onUpdateWave:function(e){var t,n=e.wave;app.model.waves.get(n._id)?app.model.waves.get(n._id).update(n):(t=new Wave(n),app.model.waves.add(t),1!==app.model.waves.length&&this.createTitle!==t.get("title")||app.navigate("wave/"+t.id,{trigger:!0}))},getMessages:function(e,t,n){var i={waveId:e.id,minParentId:t,maxRootId:n};this.socket.emit("getMessages",i)},getUser:function(e){var t={userId:e};this.socket.emit("getUser",t)},quitUser:function(e){var t={waveId:e};this.socket.emit("quitWave",t)},getInviteCode:function(e){var t={waveId:e};this.socket.emit("createInviteCode",t)},onInviteCodeReady:function(e){app.model.waves.get(e.waveId)&&app.model.waves.get(e.waveId).trigger("inviteCodeReady",e.code)},updateUser:function(e,t){var n={name:e,avatar:t};this.socket.emit("updateUser",n)},getLinkPreview:function(e,t){this.socket.emit("getLinkPreview",{msgId:t.id,url:e})},onLinkPreviewReady:function(e){app.model.messages.get(e.msgId)&&app.model.messages.get(e.msgId).addLinkPreview(e.data)}},SurfAppRouter=Backbone.Router.extend({defaults:{currentWaveId:null},initialize:function(){this.model=new SurfAppModel,this.view=new SurfAppView({model:this.model})},routes:{"wave/:number":"showWave"},showWave:function(e){this.model.waves.get(e)?(this.currentWaveId&&this.model.waves.get(this.currentWaveId).set("current",!1),this.model.waves.get(e).set("current",!0),this.currentWaveId=e):this.model.waves.length?this.showLastWave():this.navigate("/")},showLastWave:function(){var e,t;(e=this.model.messages.last())?this.navigate("wave/"+e.get("waveId"),{trigger:!0}):(t=this.model.waves.last(),this.showWave(t?t.id:null))}});window.onerror=function(e,t,n){var i={prefix:"JSERROR",errorMessage:e+" in "+t+" on line "+n+". URL: "+window.location.href+" BROWSER: "+navigator.userAgent};$.post("/logError",i)},$((function(){_.templateSettings={interpolate:/{|\|([\s\S]+?)\|}/g,escape:/{{([\s\S]+?)}}/g};var e=new SurfAppRouter;window.app=e,window.messageTemplate=_.template($("#message_view").text()),window.linkPreviewTemplate=_.template($("#message_linkpreview_view").text()),window.waveTemplate=_.template($("#wave_view").text()),Backbone.history.start(),Communicator.initialize()}));